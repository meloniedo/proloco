<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#8B4513">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Bar Manager">
    <meta name="application-name" content="Bar Manager">
    <meta name="msapplication-TileColor" content="#8B4513">
    <meta name="msapplication-tap-highlight" content="no">
    <meta name="format-detection" content="telephone=no">
    
    <!-- Manifest PWA -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="icons/icon-152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="icons/icon-192.png">
    <link rel="apple-touch-icon" sizes="167x167" href="icons/icon-152.png">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="icons/icon-72.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/icon-72.png">
    
    <!-- Apple Splash Screens -->
    <link rel="apple-touch-startup-image" href="icons/icon-512.png">
    
    <title>Proloco Santa Bianca - Bar Manager</title>
    
    <!-- CSS locale -->
    <link rel="stylesheet" href="css/style.css">
    
    <style>
        /* Font fallback senza Google Fonts (offline) */
        body { 
            font-family: Georgia, 'Times New Roman', serif; 
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        /* Supporto notch iPhone */
        .safe-top { padding-top: env(safe-area-inset-top); }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        
        /* Fullscreen mode */
        html, body {
            height: 100%;
            overflow: hidden;
        }
        
        #app {
            height: 100%;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        /* Nascondi barra indirizzi su scroll */
        html {
            height: -webkit-fill-available;
        }
        body {
            min-height: 100vh;
            min-height: -webkit-fill-available;
        }
    </style>
</head>
<body class="bg-felt min-h-screen">
    
    <div id="app"></div>

    <script>
    // ==================== REGISTRAZIONE SERVICE WORKER ====================
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('sw.js')
                .then(reg => console.log('SW registrato'))
                .catch(err => console.log('SW errore:', err));
        });
    }

    // ==================== CONFIGURAZIONE ====================
    const CONFIG = {
        nome_bar: "Proloco Santa Bianca",
        password_reset: "5054",
        categorie_spese: [
            {nome: "Cialde caff√®", icona: "‚òï", colore: "bg-amber-700"},
            {nome: "Vino", icona: "üç∑", colore: "bg-red-800"},
            {nome: "Articoli Pulizia", icona: "üßπ", colore: "bg-teal-700"},
            {nome: "Articoli S. Mercato", icona: "üõí", colore: "bg-green-700"},
            {nome: "Rimborso Servizio", icona: "üíº", colore: "bg-stone-700"},
            {nome: "Spesa Generica", icona: "üìã", colore: "bg-stone-600"}
        ]
    };

    // ==================== API FUNCTIONS ====================
    const API = {
        async getProdotti() {
            try {
                const res = await fetch('api/prodotti.php');
                return res.json();
            } catch(e) {
                console.error('Errore getProdotti:', e);
                return [];
            }
        },
        async getVendite() {
            try {
                const res = await fetch('api/vendite.php');
                return res.json();
            } catch(e) {
                return [];
            }
        },
        async getSpese() {
            try {
                const res = await fetch('api/spese.php');
                return res.json();
            } catch(e) {
                return [];
            }
        },
        async getStatistiche(periodo = 'oggi') {
            try {
                const res = await fetch(`api/statistiche.php?periodo=${periodo}`);
                return res.json();
            } catch(e) {
                return {totaleVendite: 0, totaleIncasso: 0, totaleSpese: 0, profittoNetto: 0, perCategoria: {}, prodottiPiuVenduti: []};
            }
        },
        async addVendita(vendita) {
            const res = await fetch('api/vendite.php', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(vendita)
            });
            return res.json();
        },
        async addSpesa(spesa) {
            const res = await fetch('api/spese.php', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(spesa)
            });
            return res.json();
        },
        async deleteVendita(id) {
            const res = await fetch(`api/vendite.php?id=${id}`, {method: 'DELETE'});
            return res.json();
        },
        async deleteSpesa(id) {
            const res = await fetch(`api/spese.php?id=${id}`, {method: 'DELETE'});
            return res.json();
        },
        async resetPeriodo(periodo, password) {
            const res = await fetch('api/reset.php', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({periodo, password})
            });
            return res.json();
        }
    };

    // ==================== APP STATE ====================
    const state = {
        view: 'vendita',
        periodo: 'oggi',
        prodotti: [],
        showKeypad: false,
        showResetModal: false,
        selectedProduct: null,
        selectedSpesaCategoria: '',
        customPrice: '',
        keypadMode: 'vendita',
        resetPassword: '',
        feedback: ''
    };

    // ==================== RENDERING ====================
    async function render() {
        const app = document.getElementById('app');
        app.innerHTML = `
            ${renderHeader()}
            ${renderFeedback()}
            ${await renderContent()}
            ${renderNavigation()}
            ${state.showKeypad ? renderKeypad() : ''}
            ${state.showResetModal ? renderResetModal() : ''}
        `;
        attachEventListeners();
    }

    function renderHeader() {
        return `
            <div class="header-wood sticky top-0 z-40 safe-top">
                <div class="max-w-7xl mx-auto px-4 py-4">
                    <div class="flex items-center justify-center gap-3">
                        <h1 class="text-2xl md:text-3xl font-bold text-amber-100 text-center drop-shadow-lg" style="font-family: Georgia, serif;">
                            ‚òï ${CONFIG.nome_bar}
                        </h1>
                        <div class="relative group">
                            <span class="inline-flex items-center justify-center w-4 h-4 bg-green-500 rounded-full"></span>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    function renderFeedback() {
        if (!state.feedback) return '';
        return `
            <div class="fixed top-32 left-1/2 z-50 animate-bounce" style="transform: translateX(-50%);">
                <div class="bg-amber-100 text-amber-900 px-8 py-4 rounded-2xl shadow-2xl text-xl font-bold border-4 border-amber-800">
                    ${state.feedback}
                </div>
            </div>
        `;
    }

    async function renderContent() {
        let content = '';
        switch(state.view) {
            case 'vendita': content = await renderVendita(); break;
            case 'spese': content = await renderSpese(); break;
            case 'statistiche': content = await renderStatistiche(); break;
            case 'storico': content = await renderStorico(); break;
        }
        return `<div class="max-w-7xl mx-auto px-4 py-6 pb-28">${content}</div>`;
    }

    async function renderVendita() {
        if (state.prodotti.length === 0) {
            state.prodotti = await API.getProdotti();
        }
        
        const grouped = {};
        state.prodotti.forEach(p => {
            if (!grouped[p.categoria]) grouped[p.categoria] = [];
            grouped[p.categoria].push(p);
        });

        const categoriaColors = {
            'CAFFETTERIA': 'cat-caffetteria',
            'BEVANDE': 'cat-bevande',
            'GELATI': 'cat-gelati',
            'PERSONALIZZATE': 'cat-personalizzate'
        };

        const categoriaIcons = {
            'CAFFETTERIA': '‚òï',
            'BEVANDE': 'üç∑',
            'GELATI': 'üç¶',
            'PERSONALIZZATE': 'üí∞'
        };

        let html = '<div class="space-y-8">';
        
        for (const [categoria, items] of Object.entries(grouped)) {
            html += `
                <div class="space-y-4">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="${categoriaColors[categoria]} p-3 rounded-xl text-4xl shadow-lg border-2 border-amber-900/30">
                            ${categoriaIcons[categoria]}
                        </div>
                        <h2 class="text-2xl font-bold text-amber-100 drop-shadow-lg" style="font-family: Georgia, serif;">${categoria}</h2>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
            `;
            
            items.forEach(prodotto => {
                const prezzo = parseFloat(prodotto.prezzo);
                html += `
                    <button onclick="handleProductClick(${prodotto.id})" 
                            class="${categoriaColors[prodotto.categoria]} text-amber-100 p-6 rounded-2xl shadow-xl active:scale-95 transition-transform border-2 border-amber-900/30">
                        <div class="text-4xl mb-3">${prodotto.icona}</div>
                        <div class="font-bold text-lg mb-2 leading-tight">${prodotto.nome}</div>
                        <div class="text-2xl font-black">
                            ${prezzo === 0 ? 'üí∞ Inserisci' : `‚Ç¨${prezzo.toFixed(2)}`}
                        </div>
                    </button>
                `;
            });
            
            html += `</div></div>`;
        }
        
        html += '</div>';
        return html;
    }

    async function renderSpese() {
        const spese = await API.getSpese();
        const ultime = spese.slice(0, 10);

        let html = `
            <div class="space-y-6">
                <div class="card-felt p-6 rounded-3xl border-4 border-amber-800">
                    <h2 class="text-2xl font-bold text-amber-100 mb-6 text-center" style="font-family: Georgia, serif;">üí∏ Registra Spese</h2>
                    <div class="grid grid-cols-2 gap-4">
        `;
        
        CONFIG.categorie_spese.forEach(cat => {
            html += `
                <button onclick="handleSpesaClick('${cat.nome}', '${cat.icona}')"
                        class="${cat.colore} text-amber-100 p-6 rounded-2xl shadow-xl active:scale-95 transition-transform border-2 border-amber-900/30">
                    <div class="text-4xl mb-2">${cat.icona}</div>
                    <div class="font-bold text-sm">${cat.nome}</div>
                </button>
            `;
        });
        
        html += `</div></div>
            <div class="card-felt p-6 rounded-3xl border-4 border-amber-800">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-amber-100" style="font-family: Georgia, serif;">üìã Ultime Spese</h3>
                    <button onclick="render()" class="btn-wood text-amber-100 px-4 py-2 rounded-xl text-sm">üîÑ</button>
                </div>
        `;
        
        if (ultime.length === 0) {
            html += '<div class="text-amber-200 opacity-75 text-center py-8">Nessuna spesa registrata</div>';
        } else {
            html += '<div class="space-y-2 max-h-96 overflow-y-auto hide-scrollbar">';
            ultime.forEach(s => {
                const dt = new Date(s.timestamp);
                html += `
                    <div class="bg-amber-900/30 p-4 rounded-xl flex justify-between items-center border border-amber-800/50">
                        <div class="text-amber-100">
                            <div class="font-bold">${s.categoria_spesa}</div>
                            <div class="text-xs opacity-75">${dt.toLocaleDateString('it-IT')} ${dt.toLocaleTimeString('it-IT', {hour: '2-digit', minute: '2-digit'})}</div>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="text-xl font-black text-red-400">-‚Ç¨${parseFloat(s.importo).toFixed(2)}</div>
                            <button onclick="deleteSpesa(${s.id})" class="text-red-400 p-2">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
        }
        
        html += '</div></div>';
        return html;
    }

    async function renderStatistiche() {
        const stats = await API.getStatistiche(state.periodo);
        
        let html = `
            <div class="space-y-6">
                <div class="grid grid-cols-3 gap-2">
                    ${['oggi', 'settimana', 'mese'].map(p => `
                        <button onclick="changePeriodo('${p}')"
                                class="px-3 py-2 rounded-xl font-semibold transition-all text-sm ${
                                    state.periodo === p ? 'btn-wood-active shadow-lg' : 'btn-wood-inactive'
                                }">
                            ${p === 'oggi' ? 'üìÖ Oggi' : p === 'settimana' ? 'üìÜ Sett.' : 'üóìÔ∏è Mese'}
                        </button>
                    `).join('')}
                </div>
                
                <div class="grid grid-cols-1 gap-4">
                    <div class="stat-card-green p-6 rounded-2xl shadow-xl text-amber-100 border-4 border-green-900">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-lg font-semibold">Incasso</h3>
                            <span class="text-2xl">üìà</span>
                        </div>
                        <div class="text-4xl font-black">‚Ç¨${stats.totaleIncasso.toFixed(2)}</div>
                    </div>
                    
                    <div class="stat-card-red p-6 rounded-2xl shadow-xl text-amber-100 border-4 border-red-900">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-lg font-semibold">Spese</h3>
                            <span class="text-2xl">üìâ</span>
                        </div>
                        <div class="text-4xl font-black">‚Ç¨${stats.totaleSpese.toFixed(2)}</div>
                    </div>
                    
                    <div class="${stats.profittoNetto >= 0 ? 'stat-card-blue border-blue-900' : 'stat-card-orange border-orange-900'} p-6 rounded-2xl shadow-xl text-amber-100 border-4">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-lg font-semibold">Profitto Netto</h3>
                            <span class="text-2xl">üí∞</span>
                        </div>
                        <div class="text-4xl font-black">‚Ç¨${stats.profittoNetto.toFixed(2)}</div>
                        <div class="text-sm opacity-75">${stats.totaleVendite} vendite</div>
                    </div>
                </div>
                
                <div class="card-felt p-6 rounded-3xl border-4 border-amber-800">
                    <h3 class="text-xl font-bold text-amber-100 mb-4" style="font-family: Georgia, serif;">üèÜ Top 5</h3>
                    <div class="space-y-2">
                        ${stats.prodottiPiuVenduti && stats.prodottiPiuVenduti.length > 0 ? 
                            stats.prodottiPiuVenduti.map((prod, idx) => `
                                <div class="bg-amber-900/30 p-3 rounded-xl flex justify-between items-center border border-amber-800/50">
                                    <div class="flex items-center gap-3">
                                        <div class="text-2xl font-black text-yellow-400">#${idx + 1}</div>
                                        <div class="text-amber-100">
                                            <div class="font-bold">${prod.nome}</div>
                                            <div class="text-xs opacity-75">${prod.quantita} vendite</div>
                                        </div>
                                    </div>
                                    <div class="text-xl font-black text-amber-100">‚Ç¨${prod.incasso.toFixed(2)}</div>
                                </div>
                            `).join('') : 
                            '<div class="text-amber-200 opacity-50 text-center py-4">Nessuna vendita</div>'
                        }
                    </div>
                </div>
                
                <button onclick="openResetModal()" 
                        class="w-full btn-wood text-amber-100 py-4 rounded-2xl font-bold shadow-xl flex items-center justify-center gap-2 border-2 border-red-700">
                    üóëÔ∏è üîí Reset Periodo
                </button>
            </div>
        `;
        
        return html;
    }

    async function renderStorico() {
        const vendite = await API.getVendite();
        const spese = await API.getSpese();
        
        const tutteTransazioni = [
            ...vendite.map(v => ({...v, tipo: 'vendita', prezzo: parseFloat(v.prezzo)})),
            ...spese.map(s => ({...s, tipo: 'spesa', nome_prodotto: s.categoria_spesa, prezzo: -parseFloat(s.importo)}))
        ].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).slice(0, 50);

        let html = `
            <div class="space-y-4">
                <a href="api/export.php" 
                   class="w-full bg-green-800 text-amber-100 py-4 rounded-2xl font-bold shadow-xl flex items-center justify-center gap-2 border-2 border-green-600"
                   style="display: flex; text-decoration: none;">
                    üìä Scarica Backup
                </a>
                
                <label class="w-full bg-amber-900/50 text-amber-200 py-3 rounded-xl text-sm flex items-center justify-center gap-2 border border-amber-700 cursor-pointer">
                    üì• Importa Backup
                    <input type="file" accept=".csv" onchange="handleImport(event)" style="display: none;">
                </label>
                
                <div class="card-felt p-4 rounded-2xl border-4 border-amber-800">
                    <h3 class="text-xl font-bold text-amber-100 mb-4" style="font-family: Georgia, serif;">üìã Ultime Transazioni</h3>
        `;
        
        if (tutteTransazioni.length === 0) {
            html += '<div class="text-amber-200 opacity-75 text-center py-8">Nessuna transazione</div>';
        } else {
            html += '<div class="space-y-2 max-h-96 overflow-y-auto hide-scrollbar">';
            tutteTransazioni.forEach(t => {
                const dt = new Date(t.timestamp);
                const isSpesa = t.tipo === 'spesa';
                
                html += `
                    <div class="${isSpesa ? 'bg-red-900/30 border-red-700/50' : 'bg-amber-900/30 border-amber-700/50'} p-3 rounded-xl flex justify-between items-center border">
                        <div class="${isSpesa ? 'text-red-200' : 'text-amber-100'}">
                            <div class="flex items-center gap-2">
                                <span class="text-xl">${isSpesa ? 'üí∏' : 'üí∞'}</span>
                                <div>
                                    <div class="font-bold">${t.nome_prodotto}</div>
                                    <div class="text-xs opacity-75">${dt.toLocaleDateString('it-IT')} ${dt.toLocaleTimeString('it-IT', {hour: '2-digit', minute: '2-digit'})}</div>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="text-xl font-black ${isSpesa ? 'text-red-400' : 'text-green-400'}">
                                ${isSpesa ? '-' : '+'}‚Ç¨${Math.abs(t.prezzo).toFixed(2)}
                            </div>
                            <button onclick="${isSpesa ? `deleteSpesa(${t.id})` : `deleteVendita(${t.id})`}" class="text-red-400 p-1">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
        }
        
        html += '</div></div>';
        return html;
    }

    function renderNavigation() {
        const navItems = [
            { id: 'vendita', icon: 'üõí', label: 'Vendita' },
            { id: 'spese', icon: 'üí∏', label: 'Spese' },
            { id: 'statistiche', icon: 'üìä', label: 'Stats' },
            { id: 'storico', icon: 'üìã', label: 'Storico' }
        ];
        
        return `
            <div class="nav-wood fixed bottom-0 left-0 right-0 z-40 safe-bottom">
                <div class="max-w-7xl mx-auto px-2 py-2">
                    <div class="grid grid-cols-4 gap-2">
                        ${navItems.map(item => `
                            <button onclick="changeView('${item.id}')"
                                    class="flex flex-col items-center justify-center py-3 px-2 rounded-xl font-semibold transition-all ${
                                        state.view === item.id 
                                        ? 'btn-wood-active shadow-lg' 
                                        : 'btn-wood-inactive'
                                    }">
                                <span class="text-2xl mb-1">${item.icon}</span>
                                <span class="text-xs">${item.label}</span>
                            </button>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;
    }

    function renderKeypad() {
        return `
            <div class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
                <div class="card-felt rounded-3xl shadow-2xl w-full max-w-sm p-4 border-4 border-amber-800">
                    <div class="text-center mb-4">
                        <div class="text-4xl mb-2">${state.selectedProduct?.icona || 'üí∞'}</div>
                        <h3 class="text-xl font-bold text-amber-100">${state.selectedProduct?.nome || ''}</h3>
                    </div>
                    
                    <div class="bg-amber-900/50 rounded-xl p-4 mb-4 border-2 border-amber-700">
                        <div class="text-center">
                            <div class="text-4xl font-black text-amber-100">‚Ç¨${state.customPrice || '0'}</div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-2 mb-4">
                        ${['1','2','3','4','5','6','7','8','9',',','0','‚Üê'].map(key => `
                            <button onclick="handleKeypadPress('${key}')"
                                    class="btn-wood text-amber-100 text-2xl font-bold p-4 rounded-xl active:scale-95">
                                ${key}
                            </button>
                        `).join('')}
                    </div>
                    
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="closeKeypad()" 
                                class="bg-red-800 text-amber-100 font-bold py-3 rounded-xl active:scale-95 border-2 border-red-600">
                            ‚ùå Annulla
                        </button>
                        <button onclick="confirmKeypad()" 
                                class="bg-green-800 text-amber-100 font-bold py-3 rounded-xl active:scale-95 border-2 border-green-600">
                            ‚úÖ OK
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    function renderResetModal() {
        return `
            <div class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
                <div style="background: linear-gradient(135deg, #7f1d1d 0%, #450a0a 100%);" class="rounded-3xl shadow-2xl w-full max-w-sm p-6 border-4 border-red-500">
                    <div class="text-center mb-4">
                        <div class="text-5xl mb-2">‚ö†Ô∏è</div>
                        <h3 class="text-2xl font-bold text-white">Reset ${state.periodo}</h3>
                    </div>
                    
                    <div style="background: rgba(255,255,255,0.1);" class="rounded-xl p-4 mb-4 border-2 border-red-400">
                        <input type="password" 
                               id="resetPasswordInput"
                               value="${state.resetPassword}"
                               oninput="updateResetPassword(this.value)"
                               placeholder="Password" 
                               maxlength="4"
                               class="w-full px-4 py-3 text-white text-center text-xl font-bold rounded-xl border-2 border-white/30 focus:outline-none"
                               style="background: rgba(255,255,255,0.2);">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="closeResetModal()" 
                                class="bg-stone-600 text-white font-bold py-3 rounded-xl active:scale-95">
                            Annulla
                        </button>
                        <button onclick="confirmReset()" 
                                class="bg-red-600 text-white font-bold py-3 rounded-xl active:scale-95">
                            üóëÔ∏è Reset
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    // ==================== EVENT HANDLERS ====================
    function attachEventListeners() {}

    function changeView(view) {
        state.view = view;
        render();
        document.getElementById('app').scrollTop = 0;
    }

    function changePeriodo(periodo) {
        state.periodo = periodo;
        render();
    }

    async function handleProductClick(prodottoId) {
        const prodotto = state.prodotti.find(p => p.id == prodottoId);
        if (!prodotto) return;
        
        const prezzo = parseFloat(prodotto.prezzo);
        
        if (prezzo === 0 || prodotto.categoria === 'PERSONALIZZATE') {
            state.selectedProduct = prodotto;
            state.customPrice = '';
            state.keypadMode = 'vendita';
            state.showKeypad = true;
            render();
        } else {
            await registraVendita(prodotto, prezzo);
        }
    }

    function handleSpesaClick(categoria, icona) {
        state.selectedSpesaCategoria = categoria;
        state.selectedProduct = {nome: categoria, icona: icona};
        state.customPrice = '';
        state.keypadMode = 'spesa';
        state.showKeypad = true;
        render();
    }

    function handleKeypadPress(key) {
        if (key === ',') {
            if (!state.customPrice.includes(',')) state.customPrice += ',';
        } else if (key === '‚Üê') {
            state.customPrice = state.customPrice.slice(0, -1);
        } else {
            if (state.customPrice.includes(',')) {
                const parts = state.customPrice.split(',');
                if (parts[1] && parts[1].length >= 2) return;
            }
            state.customPrice += key;
        }
        render();
    }

    function closeKeypad() {
        state.showKeypad = false;
        state.customPrice = '';
        state.selectedProduct = null;
        render();
    }

    async function confirmKeypad() {
        const prezzo = parseFloat(state.customPrice.replace(',', '.'));
        if (isNaN(prezzo) || prezzo <= 0) {
            showFeedback('‚ùå Importo non valido!');
            return;
        }
        
        state.showKeypad = false;
        
        if (state.keypadMode === 'vendita') {
            await registraVendita(state.selectedProduct, prezzo);
        } else {
            await registraSpesa(state.selectedSpesaCategoria, prezzo);
        }
        
        state.customPrice = '';
        state.selectedProduct = null;
    }

    async function registraVendita(prodotto, prezzo) {
        const vendita = {
            prodotto_id: prodotto.id,
            nome_prodotto: prodotto.nome,
            prezzo: prezzo,
            categoria: prodotto.categoria
        };
        
        const result = await API.addVendita(vendita);
        if (result.success) {
            showFeedback(`‚úÖ ${prodotto.nome} ‚Ç¨${prezzo.toFixed(2)}`);
        } else {
            showFeedback('‚ùå Errore');
        }
        render();
    }

    async function registraSpesa(categoria, importo) {
        const spesa = {
            categoria_spesa: categoria,
            importo: importo,
            note: ''
        };
        
        const result = await API.addSpesa(spesa);
        if (result.success) {
            showFeedback(`‚úÖ ${categoria} ‚Ç¨${importo.toFixed(2)}`);
        } else {
            showFeedback('‚ùå Errore');
        }
        render();
    }

    async function deleteVendita(id) {
        if (!confirm('Eliminare?')) return;
        await API.deleteVendita(id);
        showFeedback('‚úÖ Eliminata');
        render();
    }

    async function deleteSpesa(id) {
        if (!confirm('Eliminare?')) return;
        await API.deleteSpesa(id);
        showFeedback('‚úÖ Eliminata');
        render();
    }

    function openResetModal() {
        state.showResetModal = true;
        state.resetPassword = '';
        render();
    }

    function closeResetModal() {
        state.showResetModal = false;
        state.resetPassword = '';
        render();
    }

    function updateResetPassword(value) {
        state.resetPassword = value;
    }

    async function confirmReset() {
        if (state.resetPassword !== CONFIG.password_reset) {
            showFeedback('‚ùå Password errata!');
            return;
        }
        
        if (!confirm(`Eliminare dati "${state.periodo}"?`)) return;
        
        const result = await API.resetPeriodo(state.periodo, state.resetPassword);
        
        if (result.success) {
            state.showResetModal = false;
            state.resetPassword = '';
            showFeedback('‚úÖ Reset OK!');
        } else {
            showFeedback('‚ùå Errore');
        }
        render();
    }

    async function handleImport(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        showFeedback('üì• Caricamento...');
        
        const formData = new FormData();
        formData.append('file', file);
        
        try {
            const res = await fetch('api/import.php', {method: 'POST', body: formData});
            const result = await res.json();
            
            if (result.success) {
                showFeedback(`‚úÖ Importati: ${result.vendite_importate}V ${result.spese_importate}S`);
                setTimeout(() => render(), 1500);
            } else {
                showFeedback('‚ùå Errore import');
            }
        } catch(e) {
            showFeedback('‚ùå Errore');
        }
        
        event.target.value = '';
    }

    function showFeedback(message) {
        state.feedback = message;
        render();
        setTimeout(() => {
            state.feedback = '';
            render();
        }, 2000);
    }

    // ==================== INIT ====================
    render();
    </script>
</body>
</html>
