<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#8B4513">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Bar Manager">
    <meta name="application-name" content="Bar Manager">
    <meta name="format-detection" content="telephone=no">
    
    <!-- Manifest PWA -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="icons/icon.svg">
    <link rel="apple-touch-icon" sizes="152x152" href="icons/icon.svg">
    <link rel="apple-touch-icon" sizes="180x180" href="icons/icon.svg">
    <link rel="apple-touch-icon" sizes="192x192" href="icons/icon.svg">
    <link rel="icon" type="image/svg+xml" href="icons/icon.svg">
    <link rel="shortcut icon" href="icons/icon.svg">
    
    <title>Proloco Santa Bianca - Bar Manager</title>
    
    <!-- CSS locale -->
    <link rel="stylesheet" href="css/style.css">
    
    <style>
        /* ===== FONT PI√ô GRANDI PER LEGGIBILIT√Ä ===== */
        :root {
            --font-base: 18px;
            --font-lg: 20px;
            --font-xl: 24px;
            --font-2xl: 28px;
            --font-3xl: 32px;
        }
        
        body { 
            font-family: Georgia, 'Times New Roman', serif; 
            font-size: var(--font-base);
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        .safe-top { padding-top: env(safe-area-inset-top); }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        html { height: 100%; }
        body { min-height: 100vh; overflow-x: hidden; }
        #app { 
            min-height: 100vh; 
            overflow-y: auto; 
            -webkit-overflow-scrolling: touch;
            padding-bottom: 100px;
        }
        
        /* Modal input styling - PI√ô GRANDI */
        .modal-input {
            width: 100%;
            padding: 14px;
            border-radius: 8px;
            border: 2px solid #92400e;
            background: rgba(255,255,255,0.9);
            color: #78350f;
            font-size: var(--font-lg);
            margin-bottom: 12px;
        }
        .modal-input:focus {
            outline: none;
            border-color: #b45309;
        }
        .modal-select {
            width: 100%;
            padding: 14px;
            border-radius: 8px;
            border: 2px solid #92400e;
            background: rgba(255,255,255,0.9);
            color: #78350f;
            font-size: var(--font-lg);
            margin-bottom: 12px;
        }
        
        /* Testo generale pi√π grande */
        .text-sm { font-size: 16px !important; }
        .text-base { font-size: var(--font-base) !important; }
        .text-lg { font-size: var(--font-lg) !important; }
        .text-xl { font-size: var(--font-xl) !important; }
        .text-2xl { font-size: var(--font-2xl) !important; }
        
        /* Popup ora all'avvio */
        .time-popup-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.9);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .time-popup {
            background: linear-gradient(135deg, #1a4d2e 0%, #0d3320 100%);
            border: 6px solid #8B4513;
            border-radius: 20px;
            padding: 24px;
            max-width: 360px;
            width: 100%;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
        }
        .time-popup h2 {
            color: #fef3c7;
            font-size: var(--font-2xl);
            text-align: center;
            margin-bottom: 20px;
        }
        .time-popup input {
            width: 100%;
            padding: 16px;
            font-size: var(--font-xl);
            border-radius: 12px;
            border: 3px solid #b45309;
            background: rgba(255,255,255,0.95);
            color: #78350f;
            margin-bottom: 16px;
            text-align: center;
        }
        .time-popup button {
            width: 100%;
            padding: 16px;
            font-size: var(--font-lg);
            font-weight: bold;
            border-radius: 12px;
            border: 3px solid;
            cursor: pointer;
        }
        .time-popup .btn-confirm {
            background: #166534;
            color: white;
            border-color: #22c55e;
            margin-bottom: 10px;
        }
        .time-popup .btn-skip {
            background: #78350f;
            color: #fef3c7;
            border-color: #b45309;
        }
    </style>
</head>
<body class="bg-felt min-h-screen">
    
    <div id="app"></div>

    <script>
    // ==================== SERVICE WORKER ====================
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', async () => {
            try {
                const registration = await navigator.serviceWorker.register('./sw.js', {
                    scope: './'
                });
                console.log('‚úÖ Service Worker registrato:', registration.scope);
                
                // Controlla aggiornamenti
                registration.addEventListener('updatefound', () => {
                    console.log('üîÑ Nuovo Service Worker disponibile');
                });
            } catch (err) {
                console.log('‚ùå Service Worker non registrato:', err);
            }
        });
    }

    // ==================== CONFIGURAZIONE ====================
    const CONFIG = {
        nome_bar: "Proloco Santa Bianca",
        password_reset: "5054",
        categorie_spese: [
            {nome: "Cialde caff√®", icona: "‚òï", colore: "bg-amber-700"},
            {nome: "Vino", icona: "üç∑", colore: "bg-red-800"},
            {nome: "Articoli Pulizia", icona: "üßπ", colore: "bg-teal-700"},
            {nome: "Articoli S. Mercato", icona: "üõí", colore: "bg-green-700"},
            {nome: "Rimborso Servizio", icona: "üíº", colore: "bg-stone-700"},
            {nome: "Spesa Generica", icona: "üìã", colore: "bg-stone-600"}
        ],
        categorie_prodotti: ['CAFFETTERIA', 'BEVANDE', 'GELATI', 'PERSONALIZZATE'],
        icone_disponibili: ['‚òï', 'üç∑', 'ü•É', 'ü•§', 'üíß', 'üç¶', 'üé±', '‚ûï', 'üç∫', 'üßÉ', 'üçµ', 'ü•õ', 'üç∞', 'üç™', 'ü•ú', 'üì¶']
    };

    // ==================== API ====================
    const API = {
        async getProdotti() {
            try { const r = await fetch('api/prodotti.php'); return r.json(); } catch(e) { return []; }
        },
        async getVendite() {
            try { const r = await fetch('api/vendite.php'); return r.json(); } catch(e) { return []; }
        },
        async getSpese() {
            try { const r = await fetch('api/spese.php'); return r.json(); } catch(e) { return []; }
        },
        async getStatistiche(periodo = 'oggi') {
            try { const r = await fetch(`api/statistiche.php?periodo=${periodo}`); return r.json(); } 
            catch(e) { return {totaleVendite: 0, totaleIncasso: 0, totaleSpese: 0, profittoNetto: 0, perCategoria: {}, prodottiPiuVenduti: []}; }
        },
        async addVendita(v) {
            const r = await fetch('api/vendite.php', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(v)});
            return r.json();
        },
        async addSpesa(s) {
            const r = await fetch('api/spese.php', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(s)});
            return r.json();
        },
        async deleteVendita(id) { const r = await fetch(`api/vendite.php?id=${id}`, {method: 'DELETE'}); return r.json(); },
        async deleteSpesa(id) { const r = await fetch(`api/spese.php?id=${id}`, {method: 'DELETE'}); return r.json(); },
        async resetPeriodo(periodo, password) {
            const r = await fetch('api/reset.php', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({periodo, password})});
            return r.json();
        },
        // API Listino
        async getListino() {
            try { const r = await fetch('api/listino.php'); return r.json(); } catch(e) { return []; }
        },
        async addProdotto(p) {
            const r = await fetch('api/listino.php', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(p)});
            return r.json();
        },
        async updateProdotto(p) {
            const r = await fetch('api/listino.php', {method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(p)});
            return r.json();
        },
        async deleteProdotto(id) { const r = await fetch(`api/listino.php?id=${id}`, {method: 'DELETE'}); return r.json(); },
        // API USB Backup
        async getUSBStatus() {
            try { const r = await fetch('api/usb_backup.php?action=status'); return r.json(); } catch(e) { return {connected: false}; }
        },
        async doUSBBackup() {
            const r = await fetch('api/usb_backup.php?action=backup');
            return r.json();
        },
        async listUSBBackups() {
            try { const r = await fetch('api/usb_backup.php?action=list'); return r.json(); } catch(e) { return {backups: []}; }
        }
    };

    // ==================== STATE ====================
    const state = {
        view: 'vendita',
        periodo: 'oggi',
        prodotti: [],
        showKeypad: false,
        showResetModal: false,
        showAddProductModal: false,
        showEditProductModal: false,
        showTimePopup: false,
        showTimeSettings: false,
        editingProduct: null,
        selectedProduct: null,
        selectedSpesaCategoria: '',
        customPrice: '',
        keypadMode: 'vendita',
        resetPassword: '',
        feedback: '',
        usbStatus: null,
        newProduct: { nome: '', prezzo: '', categoria: 'CAFFETTERIA', icona: 'üì¶' },
        systemTime: { data: '', ora: '' }
    };

    // ==================== RENDER ====================
    async function render() {
        const app = document.getElementById('app');
        app.innerHTML = `
            ${renderHeader()}
            ${renderFeedback()}
            ${await renderContent()}
            ${renderNavigation()}
            ${state.showKeypad ? renderKeypad() : ''}
            ${state.showResetModal ? renderResetModal() : ''}
            ${state.showAddProductModal ? renderAddProductModal() : ''}
            ${state.showEditProductModal ? renderEditProductModal() : ''}
            ${state.showTimePopup ? renderTimePopup() : ''}
        `;
    }
    
    // Popup per impostare l'ora all'avvio
    function renderTimePopup() {
        const oggi = new Date();
        const dataDefault = oggi.toISOString().split('T')[0];
        const oraDefault = oggi.toTimeString().slice(0,5);
        
        return `
            <div class="time-popup-overlay">
                <div class="time-popup">
                    <h2>‚è∞ Imposta Data e Ora</h2>
                    <p style="color: #fef3c7; text-align: center; margin-bottom: 20px; font-size: 16px;">
                        L'ora del sistema potrebbe non essere corretta.<br>Verifica e imposta se necessario.
                    </p>
                    <label style="color: #fef3c7; font-size: 16px; display: block; margin-bottom: 8px;">üìÖ Data:</label>
                    <input type="date" id="popup-data" value="${state.systemTime.data || dataDefault}">
                    <label style="color: #fef3c7; font-size: 16px; display: block; margin-bottom: 8px;">üïê Ora:</label>
                    <input type="time" id="popup-ora" value="${state.systemTime.ora || oraDefault}">
                    <button class="btn-confirm" onclick="confirmTimePopup()">‚úÖ Conferma</button>
                    <button class="btn-skip" onclick="skipTimePopup()">‚è≠Ô∏è L'ora √® corretta</button>
                </div>
            </div>
        `;
    }

    function renderHeader() {
        return `
            <div class="header-wood sticky top-0 z-40 safe-top">
                <div class="max-w-7xl mx-auto px-4 py-4">
                    <div class="flex items-center justify-center gap-3">
                        <h1 style="font-size: 28px;" class="font-bold text-amber-100 text-center drop-shadow-lg">
                            ‚òï ${CONFIG.nome_bar}
                        </h1>
                        <span class="w-3 h-3 bg-green-500 rounded-full"></span>
                    </div>
                </div>
            </div>
        `;
    }

    function renderFeedback() {
        if (!state.feedback) return '';
        return `
            <div class="fixed inset-0 z-50 flex items-center justify-center pointer-events-none">
                <div class="bg-amber-100 text-amber-900 px-10 py-6 rounded-3xl shadow-2xl text-2xl font-black border-4 border-amber-800 animate-bounce text-center" style="max-width: 280px;">
                    ${state.feedback}
                </div>
            </div>
        `;
    }

    async function renderContent() {
        let content = '';
        switch(state.view) {
            case 'vendita': content = await renderVendita(); break;
            case 'spese': content = await renderSpese(); break;
            case 'statistiche': content = await renderStatistiche(); break;
            case 'storico': content = await renderStorico(); break;
            case 'impostazioni': content = await renderImpostazioni(); break;
        }
        return `<div class="max-w-7xl mx-auto px-4 py-4 pb-28">${content}</div>`;
    }

    async function renderVendita() {
        if (state.prodotti.length === 0) state.prodotti = await API.getProdotti();
        
        const grouped = {};
        state.prodotti.filter(p => p.attivo != 0).forEach(p => {
            if (!grouped[p.categoria]) grouped[p.categoria] = [];
            grouped[p.categoria].push(p);
        });

        const colors = {
            'CAFFETTERIA': 'cat-caffetteria', 'BEVANDE': 'cat-bevande',
            'GELATI': 'cat-gelati', 'PERSONALIZZATE': 'cat-personalizzate'
        };
        const icons = { 'CAFFETTERIA': '‚òï', 'BEVANDE': 'üç∑', 'GELATI': 'üç¶', 'PERSONALIZZATE': 'üí∞' };

        let html = '<div class="space-y-6">';
        for (const [cat, items] of Object.entries(grouped)) {
            html += `
                <div class="space-y-3">
                    <div class="flex items-center gap-2">
                        <div class="${colors[cat]} p-2 rounded-lg" style="font-size: 32px;">${icons[cat]}</div>
                        <h2 style="font-size: 24px;" class="font-bold text-amber-100">${cat}</h2>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        ${items.map(p => `
                            <button onclick="handleProductClick(${p.id})" 
                                class="${colors[p.categoria]} text-amber-100 p-4 rounded-xl shadow-lg active:scale-95 transition-transform border-2 border-amber-900/30">
                                <div style="font-size: 40px; margin-bottom: 8px;">${p.icona}</div>
                                <div style="font-size: 18px;" class="font-bold mb-1">${p.nome}</div>
                                <div style="font-size: 22px;" class="font-black">${parseFloat(p.prezzo) === 0 ? 'üí∞' : '‚Ç¨'+parseFloat(p.prezzo).toFixed(2)}</div>
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        html += '</div>';
        return html;
    }

    async function renderSpese() {
        const spese = (await API.getSpese()).slice(0, 10);
        let html = `
            <div class="space-y-4">
                <div class="card-felt p-4 rounded-2xl border-4 border-amber-800">
                    <h2 style="font-size: 26px;" class="font-bold text-amber-100 mb-4 text-center">üí∏ Registra Spese</h2>
                    <div class="grid grid-cols-2 gap-3">
                        ${CONFIG.categorie_spese.map(c => `
                            <button onclick="handleSpesaClick('${c.nome}', '${c.icona}')"
                                class="${c.colore} text-amber-100 p-4 rounded-xl shadow-lg active:scale-95 border-2 border-amber-900/30">
                                <div style="font-size: 36px; margin-bottom: 4px;">${c.icona}</div>
                                <div style="font-size: 16px;" class="font-bold">${c.nome}</div>
                            </button>
                        `).join('')}
                    </div>
                </div>
                <div class="card-felt p-4 rounded-2xl border-4 border-amber-800">
                    <h3 style="font-size: 22px;" class="font-bold text-amber-100 mb-3">üìã Ultime Spese</h3>
                    ${spese.length === 0 ? '<div class="text-amber-200/50 text-center py-4" style="font-size: 18px;">Nessuna spesa</div>' : 
                    `<div class="space-y-2">${spese.map(s => {
                        const dt = new Date(s.timestamp);
                        return `<div class="bg-amber-900/30 p-4 rounded-lg flex justify-between items-center border border-amber-800/50">
                            <div class="text-amber-100"><div style="font-size: 18px;" class="font-bold">${s.categoria_spesa}</div><div style="font-size: 14px;" class="opacity-75">${dt.toLocaleDateString('it-IT')}</div></div>
                            <div class="flex items-center gap-2"><span style="font-size: 20px;" class="font-black text-red-400">-‚Ç¨${parseFloat(s.importo).toFixed(2)}</span>
                            <button onclick="deleteSpesa(${s.id})" style="font-size: 22px;" class="text-red-400 p-1">üóëÔ∏è</button></div>
                        </div>`;
                    }).join('')}</div>`}
                </div>
            </div>
        `;
        return html;
    }

    async function renderStatistiche() {
        const stats = await API.getStatistiche(state.periodo);
        
        // Calcola per categoria e top 5
        const vendite = await API.getVendite();
        const perCategoria = {};
        const perProdotto = {};
        
        vendite.forEach(v => {
            const cat = v.categoria || 'ALTRO';
            const nome = v.nome_prodotto;
            const prezzo = parseFloat(v.prezzo);
            
            if (!perCategoria[cat]) perCategoria[cat] = { count: 0, totale: 0 };
            perCategoria[cat].count++;
            perCategoria[cat].totale += prezzo;
            
            if (!perProdotto[nome]) perProdotto[nome] = { count: 0, totale: 0 };
            perProdotto[nome].count++;
            perProdotto[nome].totale += prezzo;
        });
        
        // Top 5 prodotti
        const top5 = Object.entries(perProdotto)
            .sort((a, b) => b[1].count - a[1].count)
            .slice(0, 5);
        
        return `
            <div class="space-y-4">
                <div class="grid grid-cols-3 gap-2">
                    ${['oggi', 'settimana', 'mese'].map(p => `
                        <button onclick="changePeriodo('${p}')" style="font-size: 18px; padding: 12px;" class="rounded-xl font-bold ${state.periodo === p ? 'btn-wood-active' : 'btn-wood-inactive'}">
                            ${p === 'oggi' ? 'üìÖ Oggi' : p === 'settimana' ? 'üìÜ Sett.' : 'üóìÔ∏è Mese'}
                        </button>
                    `).join('')}
                </div>
                
                <!-- Riepilogo principale -->
                <div class="grid grid-cols-1 gap-3">
                    <div class="stat-card-green p-5 rounded-xl text-amber-100 border-2 border-green-800">
                        <div class="flex justify-between items-center"><span style="font-size: 20px;" class="font-semibold">Incasso</span><span style="font-size: 32px;">üìà</span></div>
                        <div style="font-size: 36px;" class="font-black">‚Ç¨${stats.totaleIncasso.toFixed(2)}</div>
                    </div>
                    <div class="stat-card-red p-5 rounded-xl text-amber-100 border-2 border-red-800">
                        <div class="flex justify-between items-center"><span style="font-size: 20px;" class="font-semibold">Spese</span><span style="font-size: 32px;">üìâ</span></div>
                        <div style="font-size: 36px;" class="font-black">‚Ç¨${stats.totaleSpese.toFixed(2)}</div>
                    </div>
                    <div class="${stats.profittoNetto >= 0 ? 'stat-card-blue border-blue-800' : 'stat-card-orange border-orange-800'} p-5 rounded-xl text-amber-100 border-2">
                        <div class="flex justify-between items-center"><span style="font-size: 20px;" class="font-semibold">Profitto</span><span style="font-size: 32px;">üí∞</span></div>
                        <div style="font-size: 36px;" class="font-black">‚Ç¨${stats.profittoNetto.toFixed(2)}</div>
                        <div style="font-size: 16px;" class="opacity-75">${stats.totaleVendite} vendite</div>
                    </div>
                </div>
                
                <!-- Top 5 Prodotti -->
                <div class="card-felt p-4 rounded-2xl border-4 border-amber-800">
                    <h3 style="font-size: 22px;" class="font-bold text-amber-100 mb-4">üèÜ Top 5 Prodotti</h3>
                    ${top5.length === 0 ? '<div class="text-amber-200/50 text-center py-4" style="font-size: 18px;">Nessuna vendita</div>' : 
                    `<div class="space-y-3">${top5.map((p, i) => `
                        <div class="bg-amber-900/30 p-4 rounded-lg flex justify-between items-center border border-amber-700">
                            <div class="flex items-center gap-3">
                                <span style="font-size: 28px; width: 40px; text-align: center;" class="font-black text-amber-300">${i + 1}.</span>
                                <span style="font-size: 20px;" class="text-amber-100 font-bold">${p[0]}</span>
                            </div>
                            <div class="text-right">
                                <div style="font-size: 20px;" class="font-bold text-green-400">‚Ç¨${p[1].totale.toFixed(2)}</div>
                                <div style="font-size: 16px;" class="text-amber-200/70">${p[1].count} vendite</div>
                            </div>
                        </div>
                    `).join('')}</div>`}
                </div>
                
                <!-- Per Categoria -->
                <div class="card-felt p-4 rounded-2xl border-4 border-amber-800">
                    <h3 style="font-size: 22px;" class="font-bold text-amber-100 mb-4">üìÅ Per Categoria</h3>
                    ${Object.keys(perCategoria).length === 0 ? '<div class="text-amber-200/50 text-center py-4" style="font-size: 18px;">Nessun dato</div>' : 
                    `<div class="space-y-3">${Object.entries(perCategoria).map(([cat, data]) => `
                        <div class="bg-amber-900/30 p-4 rounded-lg flex justify-between items-center border border-amber-700">
                            <span style="font-size: 20px;" class="text-amber-100 font-bold">${cat}</span>
                            <div class="text-right">
                                <div style="font-size: 20px;" class="font-bold text-green-400">‚Ç¨${data.totale.toFixed(2)}</div>
                                <div style="font-size: 16px;" class="text-amber-200/70">${data.count} vendite</div>
                            </div>
                        </div>
                    `).join('')}</div>`}
                </div>
                
                <button onclick="openResetModal()" style="font-size: 20px; padding: 16px;" class="w-full btn-wood text-amber-100 rounded-xl font-bold border-2 border-red-700">
                    üóëÔ∏è üîí Reset Periodo
                </button>
            </div>
        `;
    }

    async function renderStorico() {
        const vendite = await API.getVendite();
        const spese = await API.getSpese();
        
        const trans = [...vendite.map(v => ({...v, tipo: 'vendita', prezzo: parseFloat(v.prezzo)})),
                       ...spese.map(s => ({...s, tipo: 'spesa', nome_prodotto: s.categoria_spesa, prezzo: -parseFloat(s.importo)}))
        ].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).slice(0, 100);

        return `
            <div class="space-y-3">
                <div class="card-felt p-4 rounded-2xl border-4 border-amber-800">
                    <h3 style="font-size: 24px;" class="font-bold text-amber-100 mb-3">üìã Ultime 100 Transazioni</h3>
                    ${trans.length === 0 ? '<div class="text-amber-200/50 text-center py-8" style="font-size: 18px;">Nessuna transazione</div>' :
                    `<div class="space-y-2 max-h-96 overflow-y-auto hide-scrollbar">${trans.map(t => {
                        const dt = new Date(t.timestamp);
                        const isS = t.tipo === 'spesa';
                        return `<div class="${isS ? 'bg-red-900/30 border-red-700/50' : 'bg-amber-900/30 border-amber-700/50'} p-4 rounded-lg flex justify-between items-center border">
                            <div class="${isS ? 'text-red-200' : 'text-amber-100'}">
                                <div class="flex items-center gap-2">
                                    <span style="font-size: 28px;">${isS ? 'üí∏' : 'üí∞'}</span>
                                    <div>
                                        <div style="font-size: 18px;" class="font-bold">${t.nome_prodotto}</div>
                                        <div style="font-size: 14px;" class="opacity-75">${dt.toLocaleDateString('it-IT')} ${dt.toLocaleTimeString('it-IT', {hour: '2-digit', minute: '2-digit'})}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <span style="font-size: 20px;" class="font-black ${isS ? 'text-red-400' : 'text-green-400'}">${isS ? '-' : '+'}‚Ç¨${Math.abs(t.prezzo).toFixed(2)}</span>
                                <button onclick="${isS ? `deleteSpesa(${t.id})` : `deleteVendita(${t.id})`}" style="font-size: 22px;" class="text-red-400 p-1">üóëÔ∏è</button>
                            </div>
                        </div>`;
                    }).join('')}</div>`}
                </div>
            </div>
        `;
    }

    async function renderImpostazioni() {
        const listino = await API.getListino();
        state.usbStatus = await API.getUSBStatus();
        
        const usbConnected = state.usbStatus?.connected;
        
        return `
            <div class="space-y-4">
                <h2 style="font-size: 28px;" class="font-bold text-amber-100 text-center">‚öôÔ∏è Impostazioni</h2>
                
                <!-- IMPOSTA ORA SISTEMA -->
                <div class="card-felt p-4 rounded-2xl border-4 border-amber-800">
                    <div class="flex items-center justify-between mb-3">
                        <h3 style="font-size: 22px;" class="font-bold text-amber-100">üïê Ora di Sistema</h3>
                    </div>
                    <div class="bg-blue-900/30 p-3 rounded-lg mb-3 border border-blue-700">
                        <div class="text-blue-200" style="font-size: 18px;">
                            ‚è∞ Ora attuale: <strong id="current-time-display">${new Date().toLocaleString('it-IT')}</strong>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px;">
                        <div>
                            <label style="color: #fef3c7; font-size: 16px; display: block; margin-bottom: 6px;">üìÖ Data:</label>
                            <input type="date" id="settings-data" style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #3b82f6; background: rgba(0,0,0,0.3); color: #fef3c7; font-size: 18px;">
                        </div>
                        <div>
                            <label style="color: #fef3c7; font-size: 16px; display: block; margin-bottom: 6px;">üïê Ora:</label>
                            <input type="time" id="settings-ora" style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #3b82f6; background: rgba(0,0,0,0.3); color: #fef3c7; font-size: 18px;">
                        </div>
                    </div>
                    <button onclick="updateSystemTime()" style="font-size: 20px;" class="w-full bg-blue-700 hover:bg-blue-600 text-amber-100 py-3 rounded-xl font-bold border-2 border-blue-500 active:scale-95 transition-all flex items-center justify-center gap-2">
                        ‚è∞ Aggiorna Ora Sistema
                    </button>
                </div>
                
                <!-- RESOCONTO TOTALE -->
                <div class="card-felt p-4 rounded-2xl border-4 border-amber-800">
                    <div class="flex items-center justify-between mb-3">
                        <h3 style="font-size: 22px;" class="font-bold text-amber-100">üìä Resoconto Totale</h3>
                    </div>
                    <div class="bg-green-900/30 p-3 rounded-lg mb-3 border border-green-700">
                        <div class="text-green-200" style="font-size: 18px;">
                            üìã Visualizza il riepilogo completo di tutte le vendite e spese
                        </div>
                    </div>
                    <button onclick="viewResocontoTotale()" style="font-size: 20px;" class="w-full bg-green-700 hover:bg-green-600 text-amber-100 py-3 rounded-xl font-bold border-2 border-green-500 active:scale-95 transition-all flex items-center justify-center gap-2">
                        üìä Visualizza Resoconto Totale
                    </button>
                </div>
                
                <!-- BACKUP USB -->
                <div class="card-felt p-4 rounded-2xl border-4 border-amber-800">
                    <div class="flex items-center justify-between mb-3">
                        <h3 style="font-size: 22px;" class="font-bold text-amber-100">üíæ Backup su USB</h3>
                        <div class="flex items-center gap-2">
                            <span class="w-4 h-4 rounded-full ${usbConnected ? 'bg-green-500' : 'bg-red-500'} ${usbConnected ? '' : 'animate-pulse'}"></span>
                            <span style="font-size: 16px;" class="${usbConnected ? 'text-green-300' : 'text-red-300'}">
                                ${usbConnected ? 'USB Collegata' : 'USB Non Trovata'}
                            </span>
                        </div>
                    </div>
                    
                    ${usbConnected ? `
                        <div class="bg-green-900/30 p-3 rounded-lg mb-3 border border-green-700">
                            <div class="text-green-200" style="font-size: 16px;">
                                <div>üìÅ Percorso: <span class="font-mono text-xs">${state.usbStatus.path}</span></div>
                                <div>üíø Spazio: ${state.usbStatus.free_space_formatted} liberi su ${state.usbStatus.total_space_formatted}</div>
                            </div>
                        </div>
                        <button onclick="doUSBBackup()" style="font-size: 20px;" class="w-full bg-green-700 hover:bg-green-600 text-amber-100 py-3 rounded-xl font-bold border-2 border-green-500 active:scale-95 transition-all flex items-center justify-center gap-2">
                            üíæ Salva su USB (Excel)
                        </button>
                    ` : `
                        <div class="bg-red-900/30 p-3 rounded-lg mb-3 border border-red-700">
                            <div class="text-red-200" style="font-size: 16px;">
                                ‚ö†Ô∏è Inserisci una chiavetta USB per abilitare il backup
                            </div>
                        </div>
                        <button onclick="refreshUSBStatus()" style="font-size: 20px;" class="w-full bg-amber-800 hover:bg-amber-700 text-amber-100 py-3 rounded-xl font-bold border-2 border-amber-600 active:scale-95 transition-all flex items-center justify-center gap-2">
                            üîÑ Controlla USB
                        </button>
                    `}
                </div>
                
                <!-- BACKUP WIFI -->
                <div class="card-felt p-4 rounded-2xl border-4 border-amber-800">
                    <div class="flex items-center justify-between mb-3">
                        <h3 style="font-size: 22px;" class="font-bold text-amber-100">üì∂ Backup WiFi</h3>
                        <div class="flex items-center gap-2">
                            <span class="w-4 h-4 rounded-full bg-green-500"></span>
                            <span style="font-size: 16px;" class="text-green-300">Sempre disponibile</span>
                        </div>
                    </div>
                    <div class="bg-blue-900/30 p-3 rounded-lg mb-3 border border-blue-700">
                        <div class="text-blue-200" style="font-size: 16px;">
                            üì± Scarica il backup direttamente sul telefono via WiFi
                        </div>
                    </div>
                    <a href="api/download_backup.php" 
                       style="font-size: 20px; display: flex; text-decoration: none;"
                       class="w-full bg-blue-700 hover:bg-blue-600 text-amber-100 py-3 rounded-xl font-bold border-2 border-blue-500 active:scale-95 transition-all items-center justify-center gap-2">
                        üì• Scarica Backup (Excel)
                    </a>
                </div>
                
                <!-- BACKUP AUTOMATICO -->
                <div class="card-felt p-4 rounded-2xl border-4 border-amber-800" id="backup-auto-section">
                    <div class="flex items-center justify-between mb-3">
                        <h3 style="font-size: 22px;" class="font-bold text-amber-100">üïê Backup Automatico</h3>
                    </div>
                    
                    <!-- Avviso backup necessario -->
                    <div id="backup-alert" style="display:none;" class="bg-red-900/50 p-3 rounded-lg mb-3 border-2 border-red-500 animate-pulse">
                        <div class="text-red-100 font-bold flex items-center gap-2" style="font-size: 18px;">
                            ‚ö†Ô∏è BACKUP NECESSARIO!
                        </div>
                        <div class="text-red-200" style="font-size: 16px; margin-top: 4px;">
                            Il backup automatico non √® riuscito. Effettua un backup manuale.
                        </div>
                        <button onclick="resetBackupAlert()" style="font-size: 16px;" class="mt-2 bg-red-700 text-white px-3 py-1 rounded">
                            ‚úì Ho capito
                        </button>
                    </div>
                    
                    <div class="bg-purple-900/30 p-3 rounded-lg mb-3 border border-purple-700">
                        <div class="text-purple-200" style="font-size: 16px; margin-bottom: 8px;">
                            üìÖ Seleziona i giorni per il backup automatico:
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
                            <label style="display: flex; align-items: center; gap: 4px; color: #fef3c7; font-size: 16px;">
                                <input type="checkbox" id="backup-day-0" value="0" onchange="saveBackupSettings()" style="width:20px;height:20px;"> Dom
                            </label>
                            <label style="display: flex; align-items: center; gap: 4px; color: #fef3c7; font-size: 16px;">
                                <input type="checkbox" id="backup-day-1" value="1" onchange="saveBackupSettings()" style="width:20px;height:20px;"> Lun
                            </label>
                            <label style="display: flex; align-items: center; gap: 4px; color: #fef3c7; font-size: 16px;">
                                <input type="checkbox" id="backup-day-2" value="2" onchange="saveBackupSettings()" style="width:20px;height:20px;"> Mar
                            </label>
                            <label style="display: flex; align-items: center; gap: 4px; color: #fef3c7; font-size: 16px;">
                                <input type="checkbox" id="backup-day-3" value="3" onchange="saveBackupSettings()" style="width:20px;height:20px;"> Mer
                            </label>
                            <label style="display: flex; align-items: center; gap: 4px; color: #fef3c7; font-size: 16px;">
                                <input type="checkbox" id="backup-day-4" value="4" onchange="saveBackupSettings()" style="width:20px;height:20px;"> Gio
                            </label>
                            <label style="display: flex; align-items: center; gap: 4px; color: #fef3c7; font-size: 16px;">
                                <input type="checkbox" id="backup-day-5" value="5" onchange="saveBackupSettings()" style="width:20px;height:20px;"> Ven
                            </label>
                            <label style="display: flex; align-items: center; gap: 4px; color: #fef3c7; font-size: 16px;">
                                <input type="checkbox" id="backup-day-6" value="6" onchange="saveBackupSettings()" style="width:20px;height:20px;"> Sab
                            </label>
                        </div>
                        
                        <div class="text-purple-200" style="font-size: 16px; margin-top: 12px; margin-bottom: 8px;">
                            üïê Ora del backup:
                        </div>
                        <input type="time" id="backup-time" value="23:59" onchange="saveBackupSettings()" 
                            style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #7c3aed; background: rgba(0,0,0,0.3); color: #fef3c7; font-size: 20px;">
                    </div>
                    
                    <div id="backup-status" class="text-amber-200/70" style="font-size: 16px; text-align: center;">
                        Caricamento impostazioni...
                    </div>
                </div>
                
                <!-- GESTIONE LISTINO -->
                <div class="card-felt p-4 rounded-2xl border-4 border-amber-800">
                    <div class="flex justify-between items-center mb-3">
                        <h3 style="font-size: 22px;" class="font-bold text-amber-100">üìã Listino Prodotti</h3>
                        <button onclick="openAddProductModal()" style="font-size: 18px;" class="bg-green-700 text-amber-100 px-4 py-2 rounded-lg font-bold active:scale-95">
                            ‚ûï Aggiungi
                        </button>
                    </div>
                    <div class="space-y-2 max-h-80 overflow-y-auto">
                        ${listino.map(p => `
                            <div class="bg-amber-900/30 p-4 rounded-lg flex justify-between items-center border border-amber-800/50 ${p.attivo == 0 ? 'opacity-50' : ''}">
                                <div class="flex items-center gap-3">
                                    <span style="font-size: 32px;">${p.icona}</span>
                                    <div class="text-amber-100">
                                        <div style="font-size: 18px;" class="font-bold">${p.nome}</div>
                                        <div style="font-size: 16px;" class="opacity-75">${p.categoria} - ‚Ç¨${parseFloat(p.prezzo).toFixed(2)}</div>
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="openEditProductModal(${p.id})" style="font-size: 20px; padding: 8px 12px;" class="bg-amber-700 text-amber-100 rounded">‚úèÔ∏è</button>
                                    <button onclick="deleteProdotto(${p.id})" style="font-size: 20px; padding: 8px 12px;" class="bg-red-700 text-amber-100 rounded">üóëÔ∏è</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <!-- INFO -->
                <div class="card-felt p-4 rounded-2xl border-4 border-amber-800">
                    <h3 style="font-size: 22px;" class="font-bold text-amber-100 mb-2">‚ÑπÔ∏è Info Sistema</h3>
                    <div class="text-amber-200/70 space-y-1" style="font-size: 18px;">
                        <div>Password Reset: <span class="text-amber-100 font-bold">5054</span></div>
                        <div>WiFi: <span class="text-amber-100 font-bold">ProlocoBar</span></div>
                        <div>IP: <span class="text-amber-100 font-bold">192.168.4.1</span></div>
                    </div>
                </div>
            </div>
        `;
    }

    function renderNavigation() {
        const items = [
            { id: 'vendita', icon: 'üõí' },
            { id: 'spese', icon: 'üí∏' },
            { id: 'statistiche', icon: 'üìä' },
            { id: 'storico', icon: 'üìã' },
            { id: 'impostazioni', icon: '‚öôÔ∏è' }
        ];
        return `
            <div class="nav-wood" style="position: fixed; bottom: 0; left: 0; right: 0; z-index: 40; padding-bottom: env(safe-area-inset-bottom);">
                <div style="display: flex; flex-direction: row; width: 100%; padding: 8px 4px;">
                    ${items.map(i => `
                        <button onclick="changeView('${i.id}')" 
                            style="width: 20%; display: flex; align-items: center; justify-content: center; height: 60px; border-radius: 12px; border: none; cursor: pointer;"
                            class="${state.view === i.id ? 'btn-wood-active' : 'btn-wood-inactive'}">
                            <span style="font-size: 28px;">${i.icon}</span>
                        </button>
                    `).join('')}
                </div>
            </div>
        `;
    }

    function renderKeypad() {
        return `
            <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; width: 100%; height: 100%; background-color: #000000; z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 16px;">
                <div style="width: 100%; max-width: 320px; background-color: #1a4d2e; border-radius: 16px; padding: 20px; border: 6px solid #8B4513; box-shadow: 0 0 50px rgba(0,0,0,0.8);">
                    <div style="text-align: center; margin-bottom: 20px; background-color: #0d3320; padding: 15px; border-radius: 12px; border: 2px solid #2d5a3d;">
                        <div style="font-size: 50px; margin-bottom: 10px;">${state.selectedProduct?.icona || 'üí∞'}</div>
                        <h3 style="font-size: 22px; font-weight: bold; color: #fef3c7; margin: 0;">${state.selectedProduct?.nome || ''}</h3>
                    </div>
                    <div style="background-color: #78350f; border-radius: 12px; padding: 20px; margin-bottom: 20px; border: 3px solid #b45309;">
                        <div style="font-size: 42px; font-weight: 900; color: #fef3c7; text-align: center;">‚Ç¨${state.customPrice || '0'}</div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px;">
                        ${['1','2','3','4','5','6','7','8','9',',','0','‚Üê'].map(k => `
                            <button onclick="handleKeypadPress('${k}')" style="background-color: #8B4513; color: #fef3c7; font-size: 26px; font-weight: bold; padding: 18px; border-radius: 12px; border: 3px solid #a0522d; cursor: pointer;">${k}</button>
                        `).join('')}
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                        <button onclick="closeKeypad()" style="background-color: #991b1b; color: #ffffff; font-weight: bold; padding: 15px; border-radius: 12px; border: 3px solid #dc2626; font-size: 18px; cursor: pointer;">‚ùå Annulla</button>
                        <button onclick="confirmKeypad()" style="background-color: #166534; color: #ffffff; font-weight: bold; padding: 15px; border-radius: 12px; border: 3px solid #22c55e; font-size: 18px; cursor: pointer;">‚úÖ OK</button>
                    </div>
                </div>
            </div>
        `;
    }

    function renderResetModal() {
        return `
            <div class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
                <div style="background: linear-gradient(135deg, #7f1d1d 0%, #450a0a 100%);" class="rounded-2xl w-full max-w-xs p-4 border-4 border-red-500">
                    <div class="text-center mb-4">
                        <div class="text-4xl mb-2">‚ö†Ô∏è</div>
                        <h3 class="text-xl font-bold text-white">Reset ${state.periodo}</h3>
                    </div>
                    <input type="password" id="resetPwd" oninput="updateResetPassword(this.value)" placeholder="Password" maxlength="4"
                        class="w-full px-4 py-3 text-white text-center text-xl font-bold rounded-lg border-2 border-white/30 focus:outline-none mb-4" style="background: rgba(255,255,255,0.2);">
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="closeResetModal()" class="bg-stone-600 text-white font-bold py-2 rounded-lg active:scale-95">Annulla</button>
                        <button onclick="confirmReset()" class="bg-red-600 text-white font-bold py-2 rounded-lg active:scale-95">üóëÔ∏è Reset</button>
                    </div>
                </div>
            </div>
        `;
    }

    function renderAddProductModal() {
        return `
            <div class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
                <div class="card-felt rounded-2xl w-full max-w-sm p-4 border-4 border-amber-800">
                    <h3 class="text-xl font-bold text-amber-100 text-center mb-4">‚ûï Nuovo Prodotto</h3>
                    
                    <input type="text" id="newProdNome" placeholder="Nome prodotto" class="modal-input" value="${state.newProduct.nome}">
                    
                    <input type="number" id="newProdPrezzo" placeholder="Prezzo (es. 1.50)" step="0.10" class="modal-input" value="${state.newProduct.prezzo}">
                    
                    <select id="newProdCategoria" class="modal-select">
                        ${CONFIG.categorie_prodotti.map(c => `<option value="${c}" ${state.newProduct.categoria === c ? 'selected' : ''}>${c}</option>`).join('')}
                    </select>
                    
                    <div class="mb-4">
                        <label class="text-amber-100 text-sm mb-2 block">Icona:</label>
                        <div class="grid grid-cols-8 gap-1">
                            ${CONFIG.icone_disponibili.map(i => `
                                <button onclick="selectIcon('${i}')" class="text-2xl p-1 rounded ${state.newProduct.icona === i ? 'bg-amber-600' : 'bg-amber-900/50'}">${i}</button>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="closeAddProductModal()" class="bg-stone-700 text-amber-100 font-bold py-2 rounded-lg active:scale-95">Annulla</button>
                        <button onclick="saveNewProduct()" class="bg-green-700 text-amber-100 font-bold py-2 rounded-lg active:scale-95">üíæ Salva</button>
                    </div>
                </div>
            </div>
        `;
    }

    function renderEditProductModal() {
        const p = state.editingProduct;
        if (!p) return '';
        return `
            <div class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
                <div class="card-felt rounded-2xl w-full max-w-sm p-4 border-4 border-amber-800">
                    <h3 class="text-xl font-bold text-amber-100 text-center mb-4">‚úèÔ∏è Modifica Prodotto</h3>
                    
                    <input type="text" id="editProdNome" placeholder="Nome prodotto" class="modal-input" value="${p.nome}">
                    
                    <input type="number" id="editProdPrezzo" placeholder="Prezzo" step="0.10" class="modal-input" value="${p.prezzo}">
                    
                    <select id="editProdCategoria" class="modal-select">
                        ${CONFIG.categorie_prodotti.map(c => `<option value="${c}" ${p.categoria === c ? 'selected' : ''}>${c}</option>`).join('')}
                    </select>
                    
                    <div class="mb-4">
                        <label class="text-amber-100 text-sm mb-2 block">Icona:</label>
                        <div class="grid grid-cols-8 gap-1">
                            ${CONFIG.icone_disponibili.map(i => `
                                <button onclick="selectEditIcon('${i}')" class="text-2xl p-1 rounded ${p.icona === i ? 'bg-amber-600' : 'bg-amber-900/50'}">${i}</button>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="closeEditProductModal()" class="bg-stone-700 text-amber-100 font-bold py-2 rounded-lg active:scale-95">Annulla</button>
                        <button onclick="saveEditProduct()" class="bg-green-700 text-amber-100 font-bold py-2 rounded-lg active:scale-95">üíæ Salva</button>
                    </div>
                </div>
            </div>
        `;
    }

    // ==================== HANDLERS ====================
    function changeView(v) { state.view = v; render(); document.getElementById('app').scrollTop = 0; }
    function changePeriodo(p) { state.periodo = p; render(); }
    
    async function handleProductClick(id) {
        const p = state.prodotti.find(x => x.id == id);
        if (!p) return;
        if (parseFloat(p.prezzo) === 0 || p.categoria === 'PERSONALIZZATE') {
            state.selectedProduct = p; state.customPrice = ''; state.keypadMode = 'vendita'; state.showKeypad = true; render();
        } else {
            await registraVendita(p, parseFloat(p.prezzo));
        }
    }
    
    function handleSpesaClick(cat, icon) {
        state.selectedSpesaCategoria = cat; state.selectedProduct = {nome: cat, icona: icon};
        state.customPrice = ''; state.keypadMode = 'spesa'; state.showKeypad = true; render();
    }
    
    function handleKeypadPress(k) {
        if (k === ',') { if (!state.customPrice.includes(',')) state.customPrice += ','; }
        else if (k === '‚Üê') { state.customPrice = state.customPrice.slice(0, -1); }
        else { if (state.customPrice.includes(',') && state.customPrice.split(',')[1]?.length >= 2) return; state.customPrice += k; }
        render();
    }
    
    function closeKeypad() { state.showKeypad = false; state.customPrice = ''; state.selectedProduct = null; render(); }
    
    async function confirmKeypad() {
        const prezzo = parseFloat(state.customPrice.replace(',', '.'));
        if (isNaN(prezzo) || prezzo <= 0) { showFeedback('‚ùå Importo!'); return; }
        state.showKeypad = false;
        if (state.keypadMode === 'vendita') await registraVendita(state.selectedProduct, prezzo);
        else await registraSpesa(state.selectedSpesaCategoria, prezzo);
        state.customPrice = ''; state.selectedProduct = null;
    }
    
    async function registraVendita(p, prezzo) {
        const r = await API.addVendita({prodotto_id: p.id, nome_prodotto: p.nome, prezzo, categoria: p.categoria});
        showFeedback(r.success ? `‚úÖ ${p.nome} ‚Ç¨${prezzo.toFixed(2)}` : '‚ùå Errore'); render();
    }
    
    async function registraSpesa(cat, importo) {
        const r = await API.addSpesa({categoria_spesa: cat, importo, note: ''});
        showFeedback(r.success ? `‚úÖ ${cat} ‚Ç¨${importo.toFixed(2)}` : '‚ùå Errore'); render();
    }
    
    async function deleteVendita(id) { if (!confirm('Eliminare?')) return; await API.deleteVendita(id); showFeedback('‚úÖ'); render(); }
    async function deleteSpesa(id) { if (!confirm('Eliminare?')) return; await API.deleteSpesa(id); showFeedback('‚úÖ'); render(); }
    
    function openResetModal() { state.showResetModal = true; state.resetPassword = ''; render(); }
    function closeResetModal() { state.showResetModal = false; render(); }
    function updateResetPassword(v) { state.resetPassword = v; }
    
    async function confirmReset() {
        if (state.resetPassword !== CONFIG.password_reset) { showFeedback('‚ùå Password!'); return; }
        if (!confirm(`Reset ${state.periodo}?`)) return;
        const r = await API.resetPeriodo(state.periodo, state.resetPassword);
        state.showResetModal = false; showFeedback(r.success ? '‚úÖ Reset OK' : '‚ùå Errore'); render();
    }
    
    async function handleImport(e) {
        const file = e.target.files[0]; if (!file) return;
        showFeedback('üì•...');
        const fd = new FormData(); fd.append('file', file);
        try {
            const r = await (await fetch('api/import.php', {method: 'POST', body: fd})).json();
            showFeedback(r.success ? `‚úÖ ${r.vendite_importate}V ${r.spese_importate}S` : '‚ùå');
            setTimeout(render, 1500);
        } catch(e) { showFeedback('‚ùå'); }
        e.target.value = '';
    }
    
    // Listino handlers
    function openAddProductModal() { state.newProduct = {nome: '', prezzo: '', categoria: 'CAFFETTERIA', icona: 'üì¶'}; state.showAddProductModal = true; render(); }
    function closeAddProductModal() { state.showAddProductModal = false; render(); }
    function selectIcon(i) { state.newProduct.icona = i; render(); }
    
    async function saveNewProduct() {
        const nome = document.getElementById('newProdNome').value.trim();
        const prezzo = parseFloat(document.getElementById('newProdPrezzo').value) || 0;
        const categoria = document.getElementById('newProdCategoria').value;
        if (!nome) { showFeedback('‚ùå Nome!'); return; }
        const r = await API.addProdotto({nome, prezzo, categoria, icona: state.newProduct.icona});
        state.showAddProductModal = false;
        state.prodotti = []; // Force reload
        showFeedback(r.success ? '‚úÖ Aggiunto!' : '‚ùå Errore');
        render();
    }
    
    async function openEditProductModal(id) {
        const listino = await API.getListino();
        state.editingProduct = listino.find(p => p.id == id);
        if (state.editingProduct) { state.showEditProductModal = true; render(); }
    }
    function closeEditProductModal() { state.showEditProductModal = false; state.editingProduct = null; render(); }
    function selectEditIcon(i) { state.editingProduct.icona = i; render(); }
    
    async function saveEditProduct() {
        const p = state.editingProduct;
        p.nome = document.getElementById('editProdNome').value.trim();
        p.prezzo = parseFloat(document.getElementById('editProdPrezzo').value) || 0;
        p.categoria = document.getElementById('editProdCategoria').value;
        if (!p.nome) { showFeedback('‚ùå Nome!'); return; }
        const r = await API.updateProdotto(p);
        state.showEditProductModal = false; state.editingProduct = null;
        state.prodotti = [];
        showFeedback(r.success ? '‚úÖ Salvato!' : '‚ùå Errore');
        render();
    }
    
    async function deleteProdotto(id) {
        if (!confirm('Eliminare prodotto?')) return;
        await API.deleteProdotto(id);
        state.prodotti = [];
        showFeedback('‚úÖ Eliminato');
        render();
    }
    
    // USB Backup handlers
    async function refreshUSBStatus() {
        showFeedback('üîÑ Controllo...');
        state.usbStatus = await API.getUSBStatus();
        render();
    }
    
    async function doUSBBackup() {
        showFeedback('üíæ Backup in corso...');
        try {
            const r = await API.doUSBBackup();
            if (r.success) {
                // Mostra popup successo con dettagli
                alert(`‚úÖ BACKUP COMPLETATO!\n\nüìÅ File: ${r.filename}\nüí∞ Vendite: ${r.vendite}\nüí∏ Spese: ${r.spese}\nüìä Incasso: ‚Ç¨${r.totale_incasso.toFixed(2)}\nüìâ Spese: ‚Ç¨${r.totale_spese.toFixed(2)}\nüíµ Profitto: ‚Ç¨${r.profitto.toFixed(2)}`);
                showFeedback(`‚úÖ Backup salvato!`);
            } else {
                // Mostra popup errore con dettagli
                alert(`‚ùå ERRORE BACKUP\n\n${r.error || 'Errore sconosciuto'}\n\nControlla che la chiavetta USB sia inserita correttamente e riprova.`);
                showFeedback('‚ùå Errore backup');
            }
        } catch(e) {
            alert(`‚ùå ERRORE CONNESSIONE\n\nImpossibile comunicare con il server.\n\nDettaglio: ${e.message}`);
            showFeedback('‚ùå Errore');
        }
        render();
    }
    
    // Importa Backup da Excel (usa API PHP)
    async function handleImportBackup(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        // Verifica estensione
        const ext = file.name.split('.').pop().toLowerCase();
        if (!['xls', 'xlsx', 'xml'].includes(ext)) {
            alert('‚ùå Formato non supportato.\n\nUsa un file .xls generato da questa app.');
            event.target.value = '';
            return;
        }
        
        showFeedback('üì§ Importazione in corso...');
        
        try {
            const formData = new FormData();
            formData.append('file', file);
            
            const response = await fetch('api/import_backup.php', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            // Reset input file
            event.target.value = '';
            
            if (result.success) {
                alert(`‚úÖ IMPORTAZIONE COMPLETATA!\n\nüí∞ Vendite importate: ${result.vendite_importate}\nüí∏ Spese importate: ${result.spese_importate}`);
                showFeedback(`‚úÖ Importate ${result.vendite_importate}V ${result.spese_importate}S`);
                render();
            } else {
                alert(`‚ùå ERRORE IMPORTAZIONE\n\n${result.error}`);
                showFeedback('‚ùå Errore importazione');
            }
            
        } catch (e) {
            console.error('Errore importazione:', e);
            alert(`‚ùå ERRORE IMPORTAZIONE\n\n${e.message}\n\nAssicurati che il file sia un backup Excel valido generato da questa app.`);
            showFeedback('‚ùå Errore importazione');
            event.target.value = '';
        }
    }
    
    // ===== GESTIONE ORA SISTEMA =====
    
    // Controlla se serve mostrare popup ora all'avvio
    async function checkSystemTime() {
        try {
            const response = await fetch('api/system_time.php');
            const data = await response.json();
            
            if (data.needs_sync) {
                state.systemTime.data = data.data_attuale;
                state.systemTime.ora = data.ora_attuale;
                state.showTimePopup = true;
                render();
            }
        } catch (e) {
            console.log('Errore controllo ora:', e);
        }
    }
    
    // Conferma impostazione ora dal popup
    async function confirmTimePopup() {
        const data = document.getElementById('popup-data').value;
        const ora = document.getElementById('popup-ora').value;
        
        if (!data || !ora) {
            showFeedback('‚ùå Inserisci data e ora!');
            return;
        }
        
        showFeedback('‚è∞ Impostazione ora...');
        
        try {
            const response = await fetch('api/system_time.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ data, ora })
            });
            const result = await response.json();
            
            if (result.success) {
                showFeedback('‚úÖ Ora impostata!');
                state.showTimePopup = false;
                render();
            } else {
                showFeedback('‚ùå ' + (result.error || 'Errore'));
            }
        } catch (e) {
            showFeedback('‚ùå Errore connessione');
        }
    }
    
    // Salta popup ora (l'ora √® corretta)
    function skipTimePopup() {
        state.showTimePopup = false;
        // Crea flag per non mostrare pi√π il popup
        fetch('api/system_time.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ data: new Date().toISOString().split('T')[0], ora: new Date().toTimeString().slice(0,5) })
        }).catch(() => {});
        render();
    }
    
    // Aggiorna ora sistema dalle impostazioni
    async function updateSystemTime() {
        const data = document.getElementById('settings-data').value;
        const ora = document.getElementById('settings-ora').value;
        
        if (!data || !ora) {
            showFeedback('‚ùå Inserisci data e ora!');
            return;
        }
        
        if (!confirm(`Vuoi impostare l'ora del sistema a:\n${data} ${ora}?`)) {
            return;
        }
        
        showFeedback('‚è∞ Impostazione ora...');
        
        try {
            const response = await fetch('api/system_time.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ data, ora })
            });
            const result = await response.json();
            
            if (result.success) {
                showFeedback('‚úÖ Ora aggiornata!');
                // Aggiorna display
                setTimeout(() => {
                    const display = document.getElementById('current-time-display');
                    if (display) display.textContent = new Date().toLocaleString('it-IT');
                }, 1000);
            } else {
                showFeedback('‚ùå ' + (result.error || 'Errore'));
            }
        } catch (e) {
            showFeedback('‚ùå Errore connessione');
        }
    }
    
    // Inizializza campi data/ora quando si apre impostazioni
    function initTimeSettings() {
        const oggi = new Date();
        const dataInput = document.getElementById('settings-data');
        const oraInput = document.getElementById('settings-ora');
        if (dataInput) dataInput.value = oggi.toISOString().split('T')[0];
        if (oraInput) oraInput.value = oggi.toTimeString().slice(0,5);
    }
    
    // ===== RESOCONTO TOTALE =====
    
    function viewResocontoTotale() {
        window.open('api/view_resoconto.php', '_blank');
    }
    
    // ===== BACKUP AUTOMATICO =====
    
    // Carica impostazioni backup quando si apre la pagina impostazioni
    async function loadBackupSettings() {
        try {
            const response = await fetch('api/backup_settings.php');
            const data = await response.json();
            
            // Imposta checkbox giorni
            const giorni = data.giorni ? data.giorni.split(',') : ['0'];
            for (let i = 0; i <= 6; i++) {
                const cb = document.getElementById('backup-day-' + i);
                if (cb) cb.checked = giorni.includes(String(i));
            }
            
            // Imposta ora
            const timeInput = document.getElementById('backup-time');
            if (timeInput) timeInput.value = data.ora || '23:59';
            
            // Mostra avviso se backup necessario
            const alertDiv = document.getElementById('backup-alert');
            if (alertDiv) {
                alertDiv.style.display = data.backup_necessario ? 'block' : 'none';
            }
            
            // Mostra status
            const statusDiv = document.getElementById('backup-status');
            if (statusDiv) {
                const giorniNomi = ['Dom', 'Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab'];
                const giorniSelezionati = giorni.map(g => giorniNomi[parseInt(g)]).join(', ');
                statusDiv.innerHTML = `‚úì Backup programmato: <strong>${giorniSelezionati}</strong> alle <strong>${data.ora || '23:59'}</strong>`;
                
                if (data.ultimo_backup) {
                    statusDiv.innerHTML += `<br>Ultimo backup: ${data.ultimo_backup}`;
                }
            }
            
        } catch (e) {
            console.error('Errore caricamento impostazioni backup:', e);
        }
    }
    
    // Salva impostazioni backup
    async function saveBackupSettings() {
        const giorni = [];
        for (let i = 0; i <= 6; i++) {
            const cb = document.getElementById('backup-day-' + i);
            if (cb && cb.checked) giorni.push(i);
        }
        
        const timeInput = document.getElementById('backup-time');
        const ora = timeInput ? timeInput.value : '23:59';
        
        try {
            await fetch('api/backup_settings.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ giorni, ora })
            });
            
            // Aggiorna status
            const statusDiv = document.getElementById('backup-status');
            if (statusDiv && giorni.length > 0) {
                const giorniNomi = ['Dom', 'Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab'];
                const giorniSelezionati = giorni.map(g => giorniNomi[g]).join(', ');
                statusDiv.innerHTML = `‚úì Salvato! Backup: <strong>${giorniSelezionati}</strong> alle <strong>${ora}</strong>`;
            } else if (statusDiv) {
                statusDiv.innerHTML = '‚ö†Ô∏è Nessun giorno selezionato - backup disabilitato';
            }
            
            showFeedback('‚úÖ Impostazioni salvate');
        } catch (e) {
            showFeedback('‚ùå Errore salvataggio');
        }
    }
    
    // Reset avviso backup
    async function resetBackupAlert() {
        try {
            await fetch('api/backup_settings.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ reset_avviso: true })
            });
            
            const alertDiv = document.getElementById('backup-alert');
            if (alertDiv) alertDiv.style.display = 'none';
            
            showFeedback('‚úì Avviso rimosso');
        } catch (e) {
            console.error(e);
        }
    }
    
    // Carica impostazioni backup quando si va nelle impostazioni
    const originalChangeView = changeView;
    changeView = async function(view) {
        state.view = view;
        await render();
        if (view === 'impostazioni') {
            setTimeout(() => {
                loadBackupSettings();
                initTimeSettings();
            }, 100);
        }
    };
    
    function showFeedback(msg) {
        state.feedback = msg; render();
        setTimeout(() => { state.feedback = ''; render(); }, 2500);
    }
    
    // Init
    render();
    
    // Controlla ora sistema all'avvio
    setTimeout(checkSystemTime, 1000);
    </script>
</body>
</html>
