<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#8B5CF6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Bar Manager">
    
    <!-- Manifest PWA -->
    <link rel="manifest" href="./manifest.json">
    
    <!-- File Configurazione (Modificabile dall'utente) -->
    <script src="./config.js"></script>
    
    <!-- EmailJS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    
    <title>Proloco Santa Bianca - Bar Manager</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- SheetJS per Export Excel - Versione Standalone -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <style>
        body {
            overscroll-behavior: none;
            -webkit-overflow-scrolling: touch;
        }
        
        .safe-area-inset-bottom {
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .animate-bounce {
            animation: bounce 0.5s ease-in-out;
        }

        /* Nasconde scrollbar ma mantiene funzionalit√† */
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 min-h-screen">
    
    <div id="app"></div>

    <script>
    // ==================== INIZIALIZZAZIONE EMAILJS ====================
    
    (function() {
        emailjs.init(CONFIG.emailjs_public_key);
        if (CONFIG.debug) console.log('EmailJS inizializzato');
    })();
    
    // ==================== DATABASE LOCALE (localStorage) ====================
    
    class LocalDB {
        constructor() {
            this.init();
        }
        
        init() {
            if (!localStorage.getItem('prodotti')) {
                const prodottiIniziali = CONFIG.listino.map(p => ({
                    ...p,
                    id: this.generateId()
                }));
                localStorage.setItem('prodotti', JSON.stringify(prodottiIniziali));
            }
            
            if (!localStorage.getItem('vendite')) {
                localStorage.setItem('vendite', JSON.stringify([]));
            }
            
            if (!localStorage.getItem('spese')) {
                localStorage.setItem('spese', JSON.stringify([]));
            }
            
            // Inizializza ultimo resoconto inviato
            if (!localStorage.getItem('ultimoResocontoInviato')) {
                localStorage.setItem('ultimoResocontoInviato', '');
            }
        }
        
        generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }
        
        getProdotti() {
            return JSON.parse(localStorage.getItem('prodotti') || '[]');
        }
        
        getVendite() {
            return JSON.parse(localStorage.getItem('vendite') || '[]');
        }
        
        getSpese() {
            return JSON.parse(localStorage.getItem('spese') || '[]');
        }
        
        addVendita(vendita) {
            const vendite = this.getVendite();
            vendite.unshift(vendita);
            localStorage.setItem('vendite', JSON.stringify(vendite));
        }
        
        addSpesa(spesa) {
            const spese = this.getSpese();
            spese.unshift(spesa);
            localStorage.setItem('spese', JSON.stringify(spese));
        }
        
        deleteVendita(id) {
            const vendite = this.getVendite().filter(v => v.id !== id);
            localStorage.setItem('vendite', JSON.stringify(vendite));
        }
        
        deleteSpesa(id) {
            const spese = this.getSpese().filter(s => s.id !== id);
            localStorage.setItem('spese', JSON.stringify(spese));
        }
        
        resetPeriodo(periodo) {
            const now = new Date();
            let dataInizio;
            
            if (periodo === 'oggi') {
                dataInizio = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            } else if (periodo === 'settimana') {
                dataInizio = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            } else if (periodo === 'mese') {
                dataInizio = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
            }
            
            const vendite = this.getVendite().filter(v => new Date(v.timestamp) < dataInizio);
            const spese = this.getSpese().filter(s => new Date(s.timestamp) < dataInizio);
            
            localStorage.setItem('vendite', JSON.stringify(vendite));
            localStorage.setItem('spese', JSON.stringify(spese));
        }
    }
    
    const db = new LocalDB();
    
    // ==================== APP STATE ====================
    
    const state = {
        view: 'vendita',
        periodo: 'oggi',
        showKeypad: false,
        showResetModal: false,
        selectedProduct: null,
        selectedSpesaCategoria: '',
        customPrice: '',
        keypadMode: 'vendita',
        resetPassword: '',
        feedback: '',
        wakeLock: null,
        wakeLockAttivo: false,
        invioEmailInCorso: false,
        timerControlloAttivo: false
    };
    
    // ==================== FUNZIONI UTILIT√Ä DATA ====================
    
    function getGiorniDaUltimoReport() {
        const ultimoReport = localStorage.getItem('ultimoResocontoInviato');
        if (!ultimoReport) return Infinity; // Mai inviato
        
        const dataUltimo = new Date(ultimoReport);
        const now = new Date();
        const diffMs = now - dataUltimo;
        const diffGiorni = Math.floor(diffMs / (1000 * 60 * 60 * 24));
        
        return diffGiorni;
    }
    
    function getDataUltimoReport() {
        const ultimoReport = localStorage.getItem('ultimoResocontoInviato');
        if (!ultimoReport) return 'Mai inviato';
        
        const data = new Date(ultimoReport);
        return data.toLocaleDateString('it-IT', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }
    
    function isReportPendente() {
        if (!CONFIG.invio_resoconto_automatico) return false;
        
        const giorniPassati = getGiorniDaUltimoReport();
        return giorniPassati >= CONFIG.giorni_minimo_tra_report;
    }
    
    function isOraGiustaPerInvio() {
        const now = new Date();
        const giornoSettimana = now.getDay(); // 0=Domenica, 1=Luned√¨, ...
        const ora = now.getHours();
        const minuti = now.getMinutes();
        
        // Controlla se √® il giorno giusto (Luned√¨ = 1)
        if (giornoSettimana !== CONFIG.giorno_invio_report) return false;
        
        // Controlla se √® l'ora giusta (8:00)
        if (ora < CONFIG.ora_invio_report) return false;
        if (ora === CONFIG.ora_invio_report && minuti < CONFIG.minuti_invio_report) return false;
        
        return true;
    }
    
    function getSettimanaScorsa() {
        const oggi = new Date();
        // Trova il Luned√¨ di questa settimana
        const giornoSettimana = oggi.getDay();
        const diffLunedi = giornoSettimana === 0 ? 6 : giornoSettimana - 1;
        
        const lunediQuestaSett = new Date(oggi);
        lunediQuestaSett.setDate(oggi.getDate() - diffLunedi);
        lunediQuestaSett.setHours(0, 0, 0, 0);
        
        // Settimana scorsa: da Luned√¨ -7 a Domenica -1
        const lunediScorso = new Date(lunediQuestaSett);
        lunediScorso.setDate(lunediScorso.getDate() - 7);
        
        const domenicaScorsa = new Date(lunediQuestaSett);
        domenicaScorsa.setDate(domenicaScorsa.getDate() - 1);
        domenicaScorsa.setHours(23, 59, 59, 999);
        
        return {
            inizio: lunediScorso,
            fine: domenicaScorsa
        };
    }
    
    // ==================== RENDERING ====================
    
    function render() {
        const app = document.getElementById('app');
        app.innerHTML = `
            ${renderHeader()}
            ${renderFeedback()}
            ${renderContent()}
            ${renderNavigation()}
            ${state.showKeypad ? renderKeypad() : ''}
            ${state.showResetModal ? renderResetModal() : ''}
        `;
        attachEventListeners();
    }
    
    function renderHeader() {
        const reportPendente = isReportPendente();
        const giorniPassati = getGiorniDaUltimoReport();
        const dataUltimoReport = getDataUltimoReport();
        
        return `
            <div class="bg-white/10 backdrop-blur-lg border-b border-white/20 sticky top-0 z-40">
                <div class="max-w-7xl mx-auto px-4 py-4">
                    <div class="flex items-center justify-center gap-3">
                        <h1 class="text-2xl md:text-3xl font-bold text-white text-center">
                            ‚òï ${CONFIG.nome_bar}
                        </h1>
                        ${reportPendente ? `
                            <div class="relative group cursor-pointer" onclick="tentaInvioManualeResoconto()">
                                <span class="inline-flex items-center justify-center w-4 h-4 bg-orange-500 rounded-full animate-pulse" title="Report in attesa (${giorniPassati} giorni)"></span>
                                <span class="absolute -bottom-12 left-1/2 transform -translate-x-1/2 bg-black/90 text-white text-xs px-3 py-2 rounded whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity z-50">
                                    üìß Report pendente (${giorniPassati}+ giorni)
                                </span>
                            </div>
                        ` : `
                            <div class="relative group">
                                <span class="inline-flex items-center justify-center w-4 h-4 bg-green-500 rounded-full" title="Report OK"></span>
                                <span class="absolute -bottom-12 left-1/2 transform -translate-x-1/2 bg-black/90 text-white text-xs px-3 py-2 rounded whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity z-50">
                                    ‚úì Ultimo: ${giorniPassati === Infinity ? 'Mai' : giorniPassati + ' giorni fa'}
                                </span>
                            </div>
                        `}
                    </div>
                    <!-- Data ultimo report -->
                    <div class="text-center mt-2">
                        <span class="text-xs text-white/60">
                            üìß Ultimo report: ${dataUltimoReport}
                        </span>
                    </div>
                </div>
            </div>
        `;
    }
    
    function renderFeedback() {
        if (!state.feedback) return '';
        return `
            <div class="fixed top-32 left-1/2 transform -translate-x-1/2 z-50 animate-bounce">
                <div class="bg-white text-gray-900 px-8 py-4 rounded-2xl shadow-2xl text-xl font-bold">
                    ${state.feedback}
                </div>
            </div>
        `;
    }
    
    function renderContent() {
        return `
            <div class="max-w-7xl mx-auto px-4 py-6 pb-28">
                ${state.view === 'vendita' ? renderVendita() : ''}
                ${state.view === 'spese' ? renderSpese() : ''}
                ${state.view === 'statistiche' ? renderStatistiche() : ''}
                ${state.view === 'storico' ? renderStorico() : ''}
            </div>
        `;
    }
    
    function renderVendita() {
        const prodotti = db.getProdotti();
        const grouped = {};
        prodotti.forEach(p => {
            if (!grouped[p.categoria]) grouped[p.categoria] = [];
            grouped[p.categoria].push(p);
        });
        
        const categoriaColors = {
            'CAFFETTERIA': 'from-amber-500 to-orange-600',
            'BEVANDE': 'from-purple-500 to-pink-600',
            'GELATI': 'from-cyan-500 to-blue-600',
            'PERSONALIZZATE': 'from-green-500 to-emerald-600'
        };
        
        const categoriaIcons = {
            'CAFFETTERIA': '‚òï',
            'BEVANDE': 'üç∑',
            'GELATI': 'üç¶',
            'PERSONALIZZATE': 'üí∞'
        };
        
        let html = '<div class="space-y-8">';
        
        for (const [categoria, items] of Object.entries(grouped)) {
            html += `
                <div class="space-y-4">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="bg-gradient-to-r ${categoriaColors[categoria]} p-3 rounded-xl text-4xl">
                            ${categoriaIcons[categoria]}
                        </div>
                        <h2 class="text-2xl font-bold text-white">${categoria}</h2>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
            `;
            
            items.forEach(prodotto => {
                html += `
                    <button onclick="handleProductClick('${prodotto.id}')" 
                            class="bg-gradient-to-r ${categoriaColors[categoria]} text-white p-6 rounded-2xl shadow-xl hover:shadow-2xl transform hover:scale-105 transition-all duration-200 active:scale-95">
                        <div class="text-4xl mb-3">${prodotto.icona}</div>
                        <div class="font-bold text-lg mb-2 leading-tight">${prodotto.nome}</div>
                        <div class="text-2xl font-black">
                            ${prodotto.prezzo === 0 ? 'üí∞ Inserisci' : `‚Ç¨${prodotto.prezzo.toFixed(2)}`}
                        </div>
                    </button>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
        }
        
        html += '</div>';
        return html;
    }
    
    function renderSpese() {
        const spese = db.getSpese().slice(0, 10);
        const categorie = CONFIG.categorie_spese;
        
        let html = `
            <div class="space-y-6">
                <div class="bg-white/10 backdrop-blur-lg p-6 rounded-3xl border border-white/20">
                    <h2 class="text-2xl font-bold text-white mb-6 text-center">üí∏ Registra Spese</h2>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
        `;
        
        categorie.forEach(cat => {
            html += `
                <button onclick="handleSpesaClick('${cat.nome}', '${cat.icona}')"
                        class="bg-gradient-to-r ${cat.colore} text-white p-8 rounded-2xl shadow-xl hover:shadow-2xl transform hover:scale-105 transition-all active:scale-95">
                    <div class="text-5xl mb-3">${cat.icona}</div>
                    <div class="font-bold text-lg">${cat.nome}</div>
                </button>
            `;
        });
        
        html += `
                    </div>
                </div>
                
                <div class="bg-white/10 backdrop-blur-lg p-6 rounded-3xl border border-white/20">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold text-white">üìã Ultime Spese</h3>
                        <button onclick="render()" class="bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-xl transition-all">
                            üîÑ Aggiorna
                        </button>
                    </div>
        `;
        
        if (spese.length === 0) {
            html += '<div class="text-white text-center py-8 opacity-75">Nessuna spesa registrata</div>';
        } else {
            html += '<div class="space-y-2 max-h-96 overflow-y-auto hide-scrollbar">';
            spese.forEach(s => {
                const dt = new Date(s.timestamp);
                html += `
                    <div class="bg-white/10 p-4 rounded-xl flex justify-between items-center hover:bg-white/20 transition-all">
                        <div class="text-white">
                            <div class="font-bold text-lg">${s.categoria_spesa}</div>
                            <div class="text-sm opacity-75">
                                ${dt.toLocaleDateString('it-IT')} - ${dt.toLocaleTimeString('it-IT')}
                            </div>
                        </div>
                        <div class="flex items-center gap-4">
                            <div class="text-2xl font-black text-red-400">-‚Ç¨${s.importo.toFixed(2)}</div>
                            <button onclick="deleteSpesa('${s.id}')" class="text-red-400 hover:text-red-300 p-2 hover:bg-red-500/20 rounded-lg transition-all">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
        }
        
        html += `
                </div>
            </div>
        `;
        
        return html;
    }
    
    function renderStatistiche() {
        const stats = calcolaStatistiche(state.periodo);
        
        let html = `
            <div class="space-y-6">
                <div class="flex gap-2 justify-center flex-wrap">
                    ${['oggi', 'settimana', 'mese'].map(p => `
                        <button onclick="changePeriodo('${p}')"
                                class="px-6 py-3 rounded-xl font-semibold transition-all ${
                                    state.periodo === p 
                                    ? 'bg-white text-purple-900 shadow-lg' 
                                    : 'bg-white/20 text-white hover:bg-white/30'
                                }">
                            ${p === 'oggi' ? 'üìÖ Oggi' : p === 'settimana' ? 'üìÜ Settimana' : 'üóìÔ∏è Mese'}
                        </button>
                    `).join('')}
                </div>
                
                <div class="grid md:grid-cols-3 gap-6">
                    <div class="bg-gradient-to-br from-green-500 to-emerald-600 p-8 rounded-3xl shadow-2xl text-white">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-semibold">Incasso Totale</h3>
                            <span class="text-3xl">üìà</span>
                        </div>
                        <div class="text-5xl font-black">‚Ç¨${stats.totaleIncasso.toFixed(2)}</div>
                        <div class="text-green-100 mt-2">${stats.periodo}</div>
                    </div>
                    
                    <div class="bg-gradient-to-br from-red-500 to-red-600 p-8 rounded-3xl shadow-2xl text-white">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-semibold">Spese Totali</h3>
                            <span class="text-3xl">üìâ</span>
                        </div>
                        <div class="text-5xl font-black">‚Ç¨${stats.totaleSpese.toFixed(2)}</div>
                        <div class="text-red-100 mt-2">${stats.periodo}</div>
                    </div>
                    
                    <div class="bg-gradient-to-br ${stats.profittoNetto >= 0 ? 'from-blue-500 to-indigo-600' : 'from-orange-500 to-red-600'} p-8 rounded-3xl shadow-2xl text-white">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-semibold">Profitto Netto</h3>
                            <span class="text-3xl">üí∞</span>
                        </div>
                        <div class="text-5xl font-black">‚Ç¨${stats.profittoNetto.toFixed(2)}</div>
                        <div class="text-blue-100 mt-2">${stats.totaleVendite} vendite</div>
                    </div>
                </div>
                
                <div class="bg-white/10 backdrop-blur-lg p-6 rounded-3xl border border-white/20">
                    <h3 class="text-2xl font-bold text-white mb-6">üìä Per Categoria</h3>
                    <div class="grid md:grid-cols-3 gap-4">
                        ${Object.entries(stats.perCategoria).map(([cat, data]) => `
                            <div class="bg-gradient-to-br from-purple-500 to-pink-600 p-6 rounded-2xl text-white">
                                <div class="text-lg font-semibold mb-2">${cat}</div>
                                <div class="text-3xl font-black mb-1">‚Ç¨${data.incasso.toFixed(2)}</div>
                                <div class="text-sm opacity-90">${data.vendite} vendite</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div class="bg-white/10 backdrop-blur-lg p-6 rounded-3xl border border-white/20">
                    <h3 class="text-2xl font-bold text-white mb-6">üèÜ Top 5 Prodotti</h3>
                    <div class="space-y-3">
                        ${stats.prodottiPiuVenduti.length > 0 ? stats.prodottiPiuVenduti.map((prod, idx) => `
                            <div class="bg-white/10 p-4 rounded-xl flex justify-between items-center">
                                <div class="flex items-center gap-4">
                                    <div class="text-3xl font-black text-yellow-400">#${idx + 1}</div>
                                    <div class="text-white">
                                        <div class="font-bold text-lg">${prod.nome}</div>
                                        <div class="text-sm opacity-75">${prod.quantita} vendite</div>
                                    </div>
                                </div>
                                <div class="text-2xl font-black text-white">‚Ç¨${prod.incasso.toFixed(2)}</div>
                            </div>
                        `).join('') : '<div class="text-white/50 text-center py-4">Nessuna vendita nel periodo</div>'}
                    </div>
                </div>
                
                <button onclick="openResetModal()" 
                        class="w-full bg-gradient-to-r from-gray-700 to-gray-900 text-white py-4 rounded-2xl font-bold text-lg shadow-xl hover:shadow-2xl transform hover:scale-105 transition-all flex items-center justify-center gap-3 border-2 border-red-500">
                    üóëÔ∏è üîí Reset Periodo (Password Richiesta)
                </button>
            </div>
        `;
        
        return html;
    }
    
    function renderStorico() {
        const vendite = db.getVendite().slice(0, 100);
        const spese = db.getSpese().slice(0, 100);
        const reportPendente = isReportPendente();
        const giorniPassati = getGiorniDaUltimoReport();
        
        const tutteTransazioni = [
            ...vendite.map(v => ({...v, tipo: 'vendita'})),
            ...spese.map(s => ({...s, tipo: 'spesa', nome_prodotto: s.categoria_spesa, prezzo: -s.importo}))
        ].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).slice(0, 100);
        
        let html = `
            <div class="space-y-4">
                <!-- Info Report -->
                <div class="bg-white/10 backdrop-blur-lg p-4 rounded-2xl border border-white/20">
                    <div class="flex items-center justify-between">
                        <div class="text-white">
                            <div class="text-sm opacity-75">üìß Ultimo report inviato:</div>
                            <div class="font-bold">${getDataUltimoReport()}</div>
                        </div>
                        <div class="text-right">
                            ${reportPendente ? `
                                <span class="inline-flex items-center gap-2 bg-orange-500/20 text-orange-300 px-3 py-1 rounded-full text-sm">
                                    <span class="w-2 h-2 bg-orange-500 rounded-full animate-pulse"></span>
                                    Pendente (${giorniPassati}+ giorni)
                                </span>
                            ` : `
                                <span class="inline-flex items-center gap-2 bg-green-500/20 text-green-300 px-3 py-1 rounded-full text-sm">
                                    <span class="w-2 h-2 bg-green-500 rounded-full"></span>
                                    Inviato
                                </span>
                            `}
                        </div>
                    </div>
                    <div class="text-xs text-white/50 mt-2">
                        ‚è∞ Prossimo invio programmato: Luned√¨ alle 08:00 (se passati 7+ giorni)
                    </div>
                </div>
                
                <!-- Pulsante Schermo Acceso -->
                <button onclick="toggleWakeLock()" 
                        class="w-full ${state.wakeLockAttivo 
                            ? 'bg-gradient-to-r from-yellow-500 to-orange-500' 
                            : 'bg-gradient-to-r from-gray-600 to-gray-700'} text-white py-3 rounded-2xl font-bold text-lg shadow-xl hover:shadow-2xl transform hover:scale-105 transition-all flex items-center justify-center gap-3">
                    ${state.wakeLockAttivo ? 'üîÜ Schermo Acceso (Attivo)' : 'üîÖ Tieni Schermo Acceso'}
                </button>
                
                <button onclick="exportExcelCompleto()" 
                        class="w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white py-4 rounded-2xl font-bold text-lg shadow-xl hover:shadow-2xl transform hover:scale-105 transition-all flex items-center justify-center gap-3">
                    üìä Crea Resoconto Excel
                </button>
                
                <!-- Pulsante invio manuale email -->
                <button onclick="tentaInvioManualeResoconto()" 
                        class="w-full bg-gradient-to-r from-blue-500 to-indigo-600 text-white py-3 rounded-2xl font-bold text-lg shadow-xl hover:shadow-2xl transform hover:scale-105 transition-all flex items-center justify-center gap-3 ${!reportPendente ? 'opacity-50' : ''}">
                    üìß ${reportPendente ? 'Invia Report Settimanale Ora' : 'Report gi√† inviato questa settimana ‚úì'}
                </button>
                
                <!-- Input file nascosto per import -->
                <input type="file" id="importExcelInput" accept=".xlsx,.xls" style="display: none;" onchange="handleImportExcel(event)">
                
                <!-- Pulsante Import discreto -->
                <button onclick="document.getElementById('importExcelInput').click()" 
                        class="w-full bg-white/10 hover:bg-white/20 text-white/70 hover:text-white py-2 rounded-xl text-sm transition-all flex items-center justify-center gap-2 border border-white/20">
                    üì• Importa Dati da Excel
                </button>
                
                <div class="bg-white/10 backdrop-blur-lg p-6 rounded-3xl border border-white/20">
                    <h3 class="text-2xl font-bold text-white mb-6">üìã Ultime 100 Transazioni</h3>
        `;
        
        if (tutteTransazioni.length === 0) {
            html += '<div class="text-white text-center py-8 opacity-75">Nessuna transazione registrata</div>';
        } else {
            html += '<div class="space-y-2 max-h-[600px] overflow-y-auto hide-scrollbar">';
            tutteTransazioni.forEach(t => {
                const dt = new Date(t.timestamp);
                const isSpesa = t.tipo === 'spesa';
                const bgColor = isSpesa ? 'bg-red-900/30' : 'bg-white/10';
                const textColor = isSpesa ? 'text-red-300' : 'text-white';
                const priceColor = isSpesa ? 'text-red-400' : 'text-green-400';
                const icon = isSpesa ? 'üí∏' : 'üí∞';
                
                html += `
                    <div class="${bgColor} p-4 rounded-xl flex justify-between items-center hover:bg-white/20 transition-all border ${isSpesa ? 'border-red-500/30' : 'border-white/10'}">
                        <div class="${textColor}">
                            <div class="flex items-center gap-2">
                                <span class="text-2xl">${icon}</span>
                                <div>
                                    <div class="font-bold text-lg">${t.nome_prodotto}</div>
                                    <div class="text-sm opacity-75">
                                        ${dt.toLocaleDateString('it-IT')} - ${dt.toLocaleTimeString('it-IT')}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-4">
                            <div class="text-2xl font-black ${priceColor}">
                                ${isSpesa ? '-' : '+'}‚Ç¨${Math.abs(t.prezzo).toFixed(2)}
                            </div>
                            <button onclick="${isSpesa ? `deleteSpesa('${t.id}')` : `deleteVendita('${t.id}')`}" 
                                    class="text-red-400 hover:text-red-300 p-2 hover:bg-red-500/20 rounded-lg transition-all">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
        }
        
        html += `
                </div>
            </div>
        `;
        
        return html;
    }
    
    function renderNavigation() {
        return `
            <div class="fixed bottom-0 left-0 right-0 bg-white/10 backdrop-blur-lg border-t border-white/20 z-40 safe-area-inset-bottom">
                <div class="max-w-7xl mx-auto px-2 py-3">
                    <div class="grid grid-cols-4 gap-2">
                        ${['vendita', 'spese', 'statistiche', 'storico'].map(view => `
                            <button onclick="changeView('${view}')"
                                    class="flex flex-col items-center justify-center py-3 px-2 rounded-xl font-semibold transition-all ${
                                        state.view === view 
                                        ? 'bg-white text-purple-900 shadow-lg' 
                                        : 'bg-white/20 text-white hover:bg-white/30'
                                    }">
                                <span class="text-2xl mb-1">${
                                    view === 'vendita' ? 'üõí' : 
                                    view === 'spese' ? 'üí∏' : 
                                    view === 'statistiche' ? 'üìä' : 'üìã'
                                }</span>
                                <span class="text-xs capitalize">${view}</span>
                            </button>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;
    }
    
    function renderKeypad() {
        return `
            <div class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-3xl shadow-2xl max-w-md w-full p-6 border-2 border-white/20">
                    <div class="text-center mb-6">
                        <div class="text-5xl mb-3">${state.selectedProduct?.icona || 'üí∞'}</div>
                        <h3 class="text-2xl font-bold text-white mb-2">${state.selectedProduct?.nome || ''}</h3>
                        <p class="text-gray-400">Inserisci l'importo</p>
                    </div>
                    
                    <div class="bg-white/10 rounded-2xl p-6 mb-6 border-2 border-white/30">
                        <div class="text-center">
                            <div class="text-5xl font-black text-white">‚Ç¨${state.customPrice || '0'}</div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-3 mb-6">
                        ${['1','2','3','4','5','6','7','8','9',',','0','‚Üê'].map(key => `
                            <button onclick="handleKeypadPress('${key}')"
                                    class="bg-gradient-to-br from-slate-700 to-slate-800 hover:from-slate-600 hover:to-slate-700 text-white text-3xl font-bold p-6 rounded-2xl shadow-lg active:scale-95 transform transition-all border border-white/20">
                                ${key}
                            </button>
                        `).join('')}
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="closeKeypad()" 
                                class="bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white font-bold py-4 px-6 rounded-2xl shadow-lg active:scale-95 transform transition-all text-lg">
                            ‚ùå Annulla
                        </button>
                        <button onclick="confirmKeypad()" 
                                class="bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-bold py-4 px-6 rounded-2xl shadow-lg active:scale-95 transform transition-all text-lg">
                            ‚úÖ Conferma
                        </button>
                    </div>
                    
                    <button onclick="clearKeypad()" 
                            class="w-full mt-3 bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white font-bold py-3 px-6 rounded-2xl shadow-lg active:scale-95 transform transition-all">
                        üóëÔ∏è Cancella Tutto
                    </button>
                </div>
            </div>
        `;
    }
    
    function renderResetModal() {
        return `
            <div class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                <div class="bg-gradient-to-br from-red-900 to-red-950 rounded-3xl shadow-2xl max-w-md w-full p-8 border-2 border-red-500">
                    <div class="text-center mb-6">
                        <div class="text-6xl mb-4">‚ö†Ô∏è</div>
                        <h3 class="text-3xl font-bold text-white mb-2">Reset Periodo</h3>
                        <p class="text-red-200">Elimina tutti i dati del periodo: <span class="font-bold">${state.periodo}</span></p>
                    </div>
                    
                    <div class="bg-white/10 rounded-2xl p-6 mb-6 border-2 border-red-400">
                        <label class="block text-white font-semibold mb-3 text-center">Inserisci Password</label>
                        <input type="password" 
                               id="resetPasswordInput"
                               value="${state.resetPassword}"
                               oninput="updateResetPassword(this.value)"
                               placeholder="Password" 
                               maxlength="4"
                               class="w-full px-6 py-4 bg-white/20 text-white text-center text-2xl font-bold rounded-xl border-2 border-white/30 focus:border-white focus:outline-none placeholder-white/50">
                        <p class="text-xs text-red-200 mt-3 text-center">‚ö†Ô∏è Questa azione √® irreversibile!</p>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="closeResetModal()" 
                                class="bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800 text-white font-bold py-4 px-6 rounded-2xl shadow-lg active:scale-95 transform transition-all">
                            Annulla
                        </button>
                        <button onclick="confirmReset()" 
                                class="bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white font-bold py-4 px-6 rounded-2xl shadow-lg active:scale-95 transform transition-all">
                            üóëÔ∏è Reset
                        </button>
                    </div>
                </div>
            </div>
        `;
    }
    
    // ==================== WAKE LOCK (Schermo Acceso) ====================
    
    async function toggleWakeLock() {
        if (state.wakeLockAttivo) {
            // Disattiva
            if (state.wakeLock) {
                await state.wakeLock.release();
                state.wakeLock = null;
            }
            state.wakeLockAttivo = false;
            showFeedback('üîÖ Schermo acceso disattivato');
        } else {
            // Attiva
            try {
                if ('wakeLock' in navigator) {
                    state.wakeLock = await navigator.wakeLock.request('screen');
                    state.wakeLockAttivo = true;
                    showFeedback('üîÜ Schermo sempre acceso!');
                    
                    // Riattiva se la pagina torna visibile
                    document.addEventListener('visibilitychange', async () => {
                        if (state.wakeLockAttivo && document.visibilityState === 'visible') {
                            state.wakeLock = await navigator.wakeLock.request('screen');
                        }
                    });
                } else {
                    showFeedback('‚ùå Funzione non supportata su questo browser');
                }
            } catch (err) {
                console.error('Wake Lock error:', err);
                showFeedback('‚ùå Impossibile attivare schermo acceso');
            }
        }
        render();
    }
    
    // ==================== CALCOLO STATISTICHE ====================
    
    function calcolaStatistiche(periodo) {
        const now = new Date();
        let dataInizio;
        
        if (periodo === 'oggi') {
            dataInizio = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        } else if (periodo === 'settimana') {
            dataInizio = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
        } else {
            dataInizio = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
        }
        
        const vendite = db.getVendite().filter(v => new Date(v.timestamp) >= dataInizio);
        const spese = db.getSpese().filter(s => new Date(s.timestamp) >= dataInizio);
        
        const totaleVendite = vendite.length;
        const totaleIncasso = vendite.reduce((sum, v) => sum + v.prezzo, 0);
        const totaleSpese = spese.reduce((sum, s) => sum + s.importo, 0);
        const profittoNetto = totaleIncasso - totaleSpese;
        
        const perCategoria = {};
        vendite.forEach(v => {
            if (!perCategoria[v.categoria]) {
                perCategoria[v.categoria] = {vendite: 0, incasso: 0};
            }
            perCategoria[v.categoria].vendite++;
            perCategoria[v.categoria].incasso += v.prezzo;
        });
        
        const prodottiCount = {};
        vendite.forEach(v => {
            if (!prodottiCount[v.prodotto_id]) {
                prodottiCount[v.prodotto_id] = {
                    nome: v.nome_prodotto,
                    count: 0,
                    incasso: 0
                };
            }
            prodottiCount[v.prodotto_id].count++;
            prodottiCount[v.prodotto_id].incasso += v.prezzo;
        });
        
        const prodottiPiuVenduti = Object.values(prodottiCount)
            .sort((a, b) => b.count - a.count)
            .slice(0, 5)
            .map(p => ({
                nome: p.nome,
                quantita: p.count,
                incasso: p.incasso
            }));
        
        return {
            totaleVendite,
            totaleIncasso,
            totaleSpese,
            profittoNetto,
            perCategoria,
            prodottiPiuVenduti,
            periodo: periodo === 'oggi' ? 'Oggi' : periodo === 'settimana' ? 'Ultimi 7 giorni' : 'Ultimi 30 giorni'
        };
    }
    
    function calcolaStatisticheSettimanaScorsa() {
        const settimana = getSettimanaScorsa();
        
        const vendite = db.getVendite().filter(v => {
            const dt = new Date(v.timestamp);
            return dt >= settimana.inizio && dt <= settimana.fine;
        });
        
        const spese = db.getSpese().filter(s => {
            const dt = new Date(s.timestamp);
            return dt >= settimana.inizio && dt <= settimana.fine;
        });
        
        const totaleVendite = vendite.length;
        const totaleIncasso = vendite.reduce((sum, v) => sum + v.prezzo, 0);
        const totaleSpese = spese.reduce((sum, s) => sum + s.importo, 0);
        const profittoNetto = totaleIncasso - totaleSpese;
        
        const prodottiCount = {};
        vendite.forEach(v => {
            if (!prodottiCount[v.prodotto_id]) {
                prodottiCount[v.prodotto_id] = {
                    nome: v.nome_prodotto,
                    count: 0,
                    incasso: 0
                };
            }
            prodottiCount[v.prodotto_id].count++;
            prodottiCount[v.prodotto_id].incasso += v.prezzo;
        });
        
        const prodottiPiuVenduti = Object.values(prodottiCount)
            .sort((a, b) => b.count - a.count)
            .map(p => ({
                nome: p.nome,
                quantita: p.count,
                incasso: p.incasso
            }));
        
        return {
            totaleVendite,
            totaleIncasso,
            totaleSpese,
            profittoNetto,
            prodottiPiuVenduti,
            periodo: {
                inizio: settimana.inizio,
                fine: settimana.fine
            }
        };
    }
    
    // ==================== EXPORT EXCEL ====================
    
    function exportExcelCompleto(autoExport = false) {
        const vendite = db.getVendite();
        const spese = db.getSpese();
        
        const venditePerMese = {};
        const spesePerMese = {};
        
        vendite.forEach(v => {
            const dt = new Date(v.timestamp);
            const mese = `${dt.getFullYear()}-${String(dt.getMonth() + 1).padStart(2, '0')}`;
            if (!venditePerMese[mese]) venditePerMese[mese] = [];
            venditePerMese[mese].push(v);
        });
        
        spese.forEach(s => {
            const dt = new Date(s.timestamp);
            const mese = `${dt.getFullYear()}-${String(dt.getMonth() + 1).padStart(2, '0')}`;
            if (!spesePerMese[mese]) spesePerMese[mese] = [];
            spesePerMese[mese].push(s);
        });
        
        const tuttiMesi = [...new Set([...Object.keys(venditePerMese), ...Object.keys(spesePerMese)])].sort().reverse();
        
        const wb = XLSX.utils.book_new();
        
        tuttiMesi.slice(0, 12).forEach(mese => {
            const [anno, meseNum] = mese.split('-');
            const nomeMese = new Date(anno, meseNum - 1).toLocaleDateString('it-IT', {month: 'long', year: 'numeric'});
            
            const ws_data = [];
            ws_data.push([`PROLOCO SANTA BIANCA - ${nomeMese.toUpperCase()}`]);
            ws_data.push([]);
            ws_data.push(['VENDITE']);
            ws_data.push(['Data', 'Ora', 'Prodotto', 'Categoria', 'Importo ‚Ç¨']);
            
            let totaleVendite = 0;
            (venditePerMese[mese] || []).forEach(v => {
                const dt = new Date(v.timestamp);
                ws_data.push([
                    dt.toLocaleDateString('it-IT'),
                    dt.toLocaleTimeString('it-IT'),
                    v.nome_prodotto,
                    v.categoria,
                    v.prezzo
                ]);
                totaleVendite += v.prezzo;
            });
            
            ws_data.push(['', '', '', 'TOTALE VENDITE:', totaleVendite]);
            ws_data.push([]);
            ws_data.push(['SPESE']);
            ws_data.push(['Data', 'Ora', 'Categoria Spesa', 'Note', 'Importo ‚Ç¨']);
            
            let totaleSpese = 0;
            (spesePerMese[mese] || []).forEach(s => {
                const dt = new Date(s.timestamp);
                ws_data.push([
                    dt.toLocaleDateString('it-IT'),
                    dt.toLocaleTimeString('it-IT'),
                    s.categoria_spesa,
                    s.note || '',
                    s.importo
                ]);
                totaleSpese += s.importo;
            });
            
            ws_data.push(['', '', '', 'TOTALE SPESE:', totaleSpese]);
            ws_data.push([]);
            ws_data.push(['RIEPILOGO MENSILE']);
            ws_data.push([]);
            ws_data.push(['Descrizione', 'Importo ‚Ç¨']);
            ws_data.push(['Incassi Totali', totaleVendite]);
            ws_data.push(['Spese Totali', totaleSpese]);
            ws_data.push(['PROFITTO NETTO', totaleVendite - totaleSpese]);
            
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            ws['!cols'] = [{wch: 12}, {wch: 10}, {wch: 35}, {wch: 20}, {wch: 12}];
            
            XLSX.utils.book_append_sheet(wb, ws, nomeMese.substring(0, 31));
        });
        
        const now = new Date();
        const fileName = `storico_${String(now.getDate()).padStart(2, '0')}-${String(now.getMonth() + 1).padStart(2, '0')}-${now.getFullYear()}_${String(now.getHours()).padStart(2, '0')}-${String(now.getMinutes()).padStart(2, '0')}.xlsx`;
        
        try {
            XLSX.writeFile(wb, fileName);
            showFeedback(autoExport ? '‚úÖ Backup automatico completato!' : '‚úÖ Excel scaricato!');
        } catch (error) {
            showFeedback('‚ùå Errore durante export');
            console.error('Export error:', error);
        }
    }
    
    // ==================== AUTO EXPORT ====================
    
    function checkAutoExport() {
        if (!CONFIG.export_automatico_attivo) return;
        
        const now = new Date();
        if (now.getHours() === CONFIG.orario_export.ore && now.getMinutes() === CONFIG.orario_export.minuti) {
            const lastExport = localStorage.getItem('lastAutoExport');
            const today = now.toDateString();
            
            if (lastExport !== today) {
                exportExcelCompleto(true);
                localStorage.setItem('lastAutoExport', today);
            }
        }
    }
    
    setInterval(checkAutoExport, 60000);
    
    // ==================== IMPORT EXCEL ====================
    
    function handleImportExcel(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        showFeedback('üì• Caricamento file...');
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                
                let venditeTotali = 0;
                let speseTotali = 0;
                
                workbook.SheetNames.forEach(sheetName => {
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                    
                    for (let i = 0; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        if (!row || row.length === 0) continue;
                        
                        if (row[0] && row[0].toString().includes('VENDITE')) {
                            i += 2;
                            while (i < jsonData.length) {
                                const dataRow = jsonData[i];
                                if (!dataRow || dataRow.length === 0 || dataRow[3] === 'TOTALE VENDITE:') break;
                                
                                try {
                                    const vendita = {
                                        id: db.generateId(),
                                        prodotto_id: db.generateId(),
                                        nome_prodotto: dataRow[2] || 'Prodotto',
                                        prezzo: parseFloat(dataRow[4]) || 0,
                                        categoria: dataRow[3] || 'ALTRO',
                                        timestamp: parseDataOra(dataRow[0], dataRow[1])
                                    };
                                    db.addVendita(vendita);
                                    venditeTotali++;
                                } catch (err) {}
                                i++;
                            }
                        }
                        
                        if (row[0] && row[0].toString().includes('SPESE')) {
                            i += 2;
                            while (i < jsonData.length) {
                                const dataRow = jsonData[i];
                                if (!dataRow || dataRow.length === 0 || dataRow[3] === 'TOTALE SPESE:') break;
                                
                                try {
                                    const spesa = {
                                        id: db.generateId(),
                                        categoria_spesa: dataRow[2] || 'Spesa Generica',
                                        importo: parseFloat(dataRow[4]) || 0,
                                        note: dataRow[3] || '',
                                        timestamp: parseDataOra(dataRow[0], dataRow[1])
                                    };
                                    db.addSpesa(spesa);
                                    speseTotali++;
                                } catch (err) {}
                                i++;
                            }
                        }
                    }
                });
                
                event.target.value = '';
                
                if (venditeTotali > 0 || speseTotali > 0) {
                    showFeedback(`‚úÖ Importati: ${venditeTotali} vendite, ${speseTotali} spese!`);
                    setTimeout(() => {
                        if (confirm(`Import completato!\n\nVendite: ${venditeTotali}\nSpese: ${speseTotali}\n\nRicaricare l'app?`)) {
                            location.reload();
                        }
                    }, 1000);
                } else {
                    showFeedback('‚ö†Ô∏è Nessun dato trovato');
                }
            } catch (error) {
                showFeedback('‚ùå Errore lettura file');
            }
        };
        
        reader.readAsArrayBuffer(file);
    }
    
    function parseDataOra(dataStr, oraStr) {
        try {
            const [giorno, mese, anno] = dataStr.split('/');
            const [ore, minuti, secondi] = oraStr.split(':');
            return new Date(anno, mese - 1, giorno, ore, minuti, secondi).toISOString();
        } catch (err) {
            return new Date().toISOString();
        }
    }
    
    // ==================== INVIO EMAIL SETTIMANALE ====================
    
    let timerControlloId = null;
    
    async function inviaReportSettimanale() {
        if (!CONFIG.invio_resoconto_automatico) {
            if (CONFIG.debug) console.log('Invio report disattivato');
            return false;
        }
        
        if (state.invioEmailInCorso) {
            if (CONFIG.debug) console.log('Invio gi√† in corso');
            return false;
        }
        
        if (!navigator.onLine) {
            if (CONFIG.debug) console.log('Offline - impossibile inviare');
            return false;
        }
        
        state.invioEmailInCorso = true;
        showFeedback('üìß Invio report settimanale...');
        
        try {
            const stats = calcolaStatisticheSettimanaScorsa();
            const ultimoReport = getDataUltimoReport();
            
            const periodoStr = `${stats.periodo.inizio.toLocaleDateString('it-IT')} - ${stats.periodo.fine.toLocaleDateString('it-IT')}`;
            
            const topProdottiStr = stats.prodottiPiuVenduti.slice(0, 3).map((p, i) => 
                `${i+1}. ${p.nome}: ${p.quantita} vendite - ‚Ç¨${p.incasso.toFixed(2)}`
            ).join('\n') || 'Nessuna vendita nel periodo';
            
            const templateParams = {
                destinatari: CONFIG.email_destinatari,
                nome_bar: CONFIG.nome_bar,
                data: new Date().toLocaleDateString('it-IT') + ' ' + new Date().toLocaleTimeString('it-IT'),
                periodo: periodoStr,
                ultimo_report: ultimoReport,
                totale_vendite: stats.totaleVendite.toString(),
                incasso_totale: stats.totaleIncasso.toFixed(2),
                spese_totali: stats.totaleSpese.toFixed(2),
                profitto_netto: stats.profittoNetto.toFixed(2),
                top_prodotti: topProdottiStr
            };
            
            if (CONFIG.debug) console.log('Invio email con:', templateParams);
            
            const response = await emailjs.send(
                CONFIG.emailjs_service_id,
                CONFIG.emailjs_template_id,
                templateParams
            );
            
            if (response.status === 200) {
                localStorage.setItem('ultimoResocontoInviato', new Date().toISOString());
                
                showFeedback('‚úÖ Report settimanale inviato!');
                console.log('üìß Report inviato:', new Date().toISOString());
                
                // Ferma il timer di controllo
                stopTimerControllo();
                
                setTimeout(() => {
                    state.invioEmailInCorso = false;
                    render();
                }, 2000);
                
                return true;
            } else {
                throw new Error('Risposta non OK');
            }
        } catch (error) {
            console.error('‚ùå Errore invio:', error);
            showFeedback('‚ùå Errore invio. Riprovo...');
            state.invioEmailInCorso = false;
            return false;
        }
    }
    
    async function tentaInvioManualeResoconto() {
        if (!isReportPendente()) {
            showFeedback('‚úÖ Report gi√† inviato questa settimana!');
            return;
        }
        
        if (!navigator.onLine) {
            showFeedback('‚ùå Nessuna connessione!');
            return;
        }
        
        await inviaReportSettimanale();
    }
    
    // ==================== TIMER CONTROLLO CONNESSIONE ====================
    
    function startTimerControllo() {
        if (timerControlloId) return; // Gi√† attivo
        
        if (CONFIG.debug) console.log('‚è∞ Timer controllo ATTIVATO (ogni', CONFIG.timer_controllo_minuti, 'minuti)');
        
        timerControlloId = setInterval(async () => {
            if (CONFIG.debug) console.log('‚è∞ Controllo periodico...');
            
            if (navigator.onLine && isReportPendente()) {
                if (CONFIG.debug) console.log('Online + Report pendente ‚Üí tento invio');
                await inviaReportSettimanale();
            }
        }, CONFIG.timer_controllo_minuti * 60 * 1000);
        
        state.timerControlloAttivo = true;
    }
    
    function stopTimerControllo() {
        if (timerControlloId) {
            clearInterval(timerControlloId);
            timerControlloId = null;
            state.timerControlloAttivo = false;
            if (CONFIG.debug) console.log('‚è∞ Timer controllo FERMATO');
        }
    }
    
    // Listener connessione
    window.addEventListener('online', async () => {
        if (CONFIG.debug) console.log('üì∂ Connessione rilevata!');
        
        if (isReportPendente()) {
            showFeedback('üì∂ Online! Controllo report...');
            
            setTimeout(async () => {
                if (navigator.onLine && isReportPendente()) {
                    await inviaReportSettimanale();
                }
            }, 2000);
        }
    });
    
    window.addEventListener('offline', () => {
        if (CONFIG.debug) console.log('üì¥ Offline');
    });
    
    // ==================== INIT ====================
    
    // Controllo iniziale all'avvio
    setTimeout(async () => {
        if (CONFIG.debug) {
            console.log('üöÄ App avviata');
            console.log('üìß Report pendente:', isReportPendente());
            console.log('üìÖ Giorni da ultimo report:', getGiorniDaUltimoReport());
            console.log('üì∂ Online:', navigator.onLine);
        }
        
        // Se √® passata pi√π di 1 settimana, attiva il timer
        if (isReportPendente()) {
            if (CONFIG.debug) console.log('Report pendente - attivo timer controllo');
            startTimerControllo();
            
            // Prova subito se online
            if (navigator.onLine) {
                await inviaReportSettimanale();
            }
        }
    }, 3000);
    
    // Controllo ogni minuto per l'orario programmato (Luned√¨ 8:00)
    setInterval(() => {
        if (isOraGiustaPerInvio() && isReportPendente()) {
            if (CONFIG.debug) console.log('√à Luned√¨ 8:00 + Report pendente');
            
            if (navigator.onLine) {
                inviaReportSettimanale();
            } else {
                // Attiva timer se non online
                startTimerControllo();
            }
        }
    }, 60000);
    
    // ==================== EVENT HANDLERS ====================
    
    function changeView(view) {
        state.view = view;
        render();
        window.scrollTo(0, 0);
    }
    
    function changePeriodo(periodo) {
        state.periodo = periodo;
        render();
    }
    
    function handleProductClick(prodottoId) {
        const prodotto = db.getProdotti().find(p => p.id === prodottoId);
        if (!prodotto) return;
        
        if (prodotto.prezzo === 0 || prodotto.categoria === 'PERSONALIZZATE') {
            state.selectedProduct = prodotto;
            state.customPrice = '';
            state.keypadMode = 'vendita';
            state.showKeypad = true;
            render();
        } else {
            registraVendita(prodotto, prodotto.prezzo);
        }
    }
    
    function handleSpesaClick(categoria, icona) {
        state.selectedSpesaCategoria = categoria;
        state.selectedProduct = {nome: categoria, icona: icona};
        state.customPrice = '';
        state.keypadMode = 'spesa';
        state.showKeypad = true;
        render();
    }
    
    function handleKeypadPress(key) {
        if (key === ',') {
            if (!state.customPrice.includes(',')) state.customPrice += ',';
        } else if (key === '‚Üê') {
            state.customPrice = state.customPrice.slice(0, -1);
        } else {
            if (state.customPrice.includes(',')) {
                const parts = state.customPrice.split(',');
                if (parts[1] && parts[1].length >= 2) return;
            }
            state.customPrice += key;
        }
        render();
    }
    
    function closeKeypad() {
        state.showKeypad = false;
        state.customPrice = '';
        state.selectedProduct = null;
        render();
    }
    
    function clearKeypad() {
        state.customPrice = '';
        render();
    }
    
    function confirmKeypad() {
        const prezzo = parseFloat(state.customPrice.replace(',', '.'));
        if (isNaN(prezzo) || prezzo <= 0) {
            showFeedback('‚ùå Importo non valido!');
            return;
        }
        
        state.showKeypad = false;
        
        if (state.keypadMode === 'vendita') {
            registraVendita(state.selectedProduct, prezzo);
        } else {
            registraSpesa(state.selectedSpesaCategoria, prezzo);
        }
        
        state.customPrice = '';
        state.selectedProduct = null;
        render();
    }
    
    function registraVendita(prodotto, prezzo) {
        const vendita = {
            id: db.generateId(),
            prodotto_id: prodotto.id,
            nome_prodotto: prodotto.nome,
            prezzo: prezzo,
            categoria: prodotto.categoria,
            timestamp: new Date().toISOString()
        };
        
        db.addVendita(vendita);
        showFeedback(`‚úÖ ${prodotto.nome} - ‚Ç¨${prezzo.toFixed(2)}`);
        render();
    }
    
    function registraSpesa(categoria, importo) {
        const spesa = {
            id: db.generateId(),
            categoria_spesa: categoria,
            importo: importo,
            note: '',
            timestamp: new Date().toISOString()
        };
        
        db.addSpesa(spesa);
        showFeedback(`‚úÖ Spesa: ${categoria} - ‚Ç¨${importo.toFixed(2)}`);
        render();
    }
    
    function deleteVendita(id) {
        if (!confirm('Eliminare questa vendita?')) return;
        db.deleteVendita(id);
        showFeedback('‚úÖ Eliminata');
        render();
    }
    
    function deleteSpesa(id) {
        if (!confirm('Eliminare questa spesa?')) return;
        db.deleteSpesa(id);
        showFeedback('‚úÖ Eliminata');
        render();
    }
    
    function openResetModal() {
        state.showResetModal = true;
        state.resetPassword = '';
        render();
    }
    
    function closeResetModal() {
        state.showResetModal = false;
        state.resetPassword = '';
        render();
    }
    
    function updateResetPassword(value) {
        state.resetPassword = value;
    }
    
    function confirmReset() {
        if (state.resetPassword !== CONFIG.password_reset) {
            showFeedback('‚ùå Password errata!');
            return;
        }
        
        if (!confirm(`Eliminare TUTTI i dati del periodo "${state.periodo}"?`)) return;
        
        db.resetPeriodo(state.periodo);
        state.showResetModal = false;
        state.resetPassword = '';
        showFeedback('‚úÖ Reset completato!');
        render();
    }
    
    function showFeedback(message) {
        state.feedback = message;
        render();
        setTimeout(() => {
            state.feedback = '';
            render();
        }, 2500);
    }
    
    function attachEventListeners() {}
    
    // Initial render
    render();
    
    // Service Worker
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./sw.js', { scope: './' })
            .then(reg => console.log('SW registrato'))
            .catch(err => console.log('SW errore:', err));
    }
    </script>
</body>
</html>
