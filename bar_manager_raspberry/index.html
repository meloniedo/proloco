<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#8B5CF6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Bar Manager">
    
    <title>Proloco Santa Bianca - Bar Manager</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- SheetJS per Export Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <style>
        body {
            overscroll-behavior: none;
            -webkit-overflow-scrolling: touch;
        }
        
        .safe-area-inset-bottom {
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .animate-bounce {
            animation: bounce 0.5s ease-in-out;
        }

        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .animate-pulse-slow {
            animation: pulse 2s ease-in-out infinite;
        }
        
        .connection-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 100;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 min-h-screen">
    
    <!-- Indicatore connessione -->
    <div id="connectionIndicator" class="connection-indicator">
        <div class="flex items-center gap-2 bg-black/50 backdrop-blur px-3 py-1 rounded-full">
            <div id="connectionDot" class="w-2 h-2 rounded-full bg-red-500"></div>
            <span id="connectionText" class="text-xs text-white/70">Offline</span>
        </div>
    </div>
    
    <div id="app"></div>

    <script>
    // ==================== API CLIENT ====================
    
    const API_BASE = window.location.origin;
    
    async function apiCall(endpoint, method = 'GET', body = null) {
        try {
            const options = {
                method,
                headers: { 'Content-Type': 'application/json' }
            };
            if (body) options.body = JSON.stringify(body);
            
            const response = await fetch(`${API_BASE}${endpoint}`, options);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return await response.json();
        } catch (error) {
            console.error('API Error:', error);
            throw error;
        }
    }
    
    // ==================== APP STATE ====================
    
    let CONFIG = {
        nome_bar: "Bar Manager",
        listino: [],
        categorie_spese: [],
        password_reset: "5054"
    };
    
    let prodotti = [];
    let vendite = [];
    let spese = [];
    
    const state = {
        view: 'vendita',
        periodo: 'oggi',
        showKeypad: false,
        showResetModal: false,
        showImportModal: false,
        selectedProduct: null,
        selectedSpesaCategoria: '',
        customPrice: '',
        keypadMode: 'vendita',
        resetPassword: '',
        feedback: '',
        loading: false,
        online: false,
        ultimoReport: null
    };
    
    // ==================== INIT ====================
    
    async function init() {
        state.loading = true;
        render();
        
        try {
            // Carica config
            const config = await apiCall('/api/config');
            CONFIG = config;
            
            // Carica prodotti
            prodotti = await apiCall('/api/prodotti');
            
            // Carica vendite e spese
            await refreshData();
            
            // Carica status
            await checkStatus();
            
        } catch (error) {
            console.error('Init error:', error);
            showFeedback('‚ùå Errore connessione al server');
        }
        
        state.loading = false;
        render();
        
        // Polling per aggiornamenti (ogni 5 secondi)
        setInterval(refreshData, 5000);
        setInterval(checkStatus, 10000);
    }
    
    async function refreshData() {
        try {
            vendite = await apiCall('/api/vendite');
            spese = await apiCall('/api/spese');
            if (state.view === 'statistiche' || state.view === 'storico') {
                render();
            }
        } catch (error) {
            console.error('Refresh error:', error);
        }
    }
    
    async function checkStatus() {
        try {
            const status = await apiCall('/api/status');
            state.online = status.online;
            state.ultimoReport = status.ultimo_report;
            updateConnectionIndicator();
        } catch (error) {
            state.online = false;
            updateConnectionIndicator();
        }
    }
    
    function updateConnectionIndicator() {
        const dot = document.getElementById('connectionDot');
        const text = document.getElementById('connectionText');
        if (dot && text) {
            if (state.online) {
                dot.className = 'w-2 h-2 rounded-full bg-green-500 animate-pulse-slow';
                text.textContent = 'Online';
            } else {
                dot.className = 'w-2 h-2 rounded-full bg-red-500';
                text.textContent = 'Offline';
            }
        }
    }
    
    // ==================== RENDERING ====================
    
    function render() {
        const app = document.getElementById('app');
        
        if (state.loading) {
            app.innerHTML = `
                <div class="min-h-screen flex items-center justify-center">
                    <div class="text-center">
                        <div class="text-6xl mb-4">‚òï</div>
                        <div class="text-white text-xl">Caricamento...</div>
                    </div>
                </div>
            `;
            return;
        }
        
        app.innerHTML = `
            ${renderHeader()}
            ${renderFeedback()}
            ${renderContent()}
            ${renderNavigation()}
            ${state.showKeypad ? renderKeypad() : ''}
            ${state.showResetModal ? renderResetModal() : ''}
            ${state.showImportModal ? renderImportModal() : ''}
        `;
    }
    
    function renderHeader() {
        return `
            <div class="bg-white/10 backdrop-blur-lg border-b border-white/20 sticky top-0 z-40">
                <div class="max-w-7xl mx-auto px-4 py-4">
                    <div class="flex items-center justify-center gap-3">
                        <h1 class="text-2xl md:text-3xl font-bold text-white text-center">
                            ‚òï ${CONFIG.nome_bar}
                        </h1>
                    </div>
                    <div class="text-center text-white/50 text-xs mt-1">
                        Multi-dispositivo ‚Ä¢ Dati sincronizzati
                    </div>
                </div>
            </div>
        `;
    }
    
    function renderFeedback() {
        if (!state.feedback) return '';
        return `
            <div class="fixed top-24 left-1/2 transform -translate-x-1/2 z-50 animate-bounce">
                <div class="bg-white text-gray-900 px-8 py-4 rounded-2xl shadow-2xl text-xl font-bold">
                    ${state.feedback}
                </div>
            </div>
        `;
    }
    
    function renderContent() {
        return `
            <div class="max-w-7xl mx-auto px-4 py-6 pb-28">
                ${state.view === 'vendita' ? renderVendita() : ''}
                ${state.view === 'spese' ? renderSpese() : ''}
                ${state.view === 'statistiche' ? renderStatistiche() : ''}
                ${state.view === 'storico' ? renderStorico() : ''}
            </div>
        `;
    }
    
    function renderVendita() {
        const grouped = {};
        prodotti.forEach(p => {
            if (!grouped[p.categoria]) grouped[p.categoria] = [];
            grouped[p.categoria].push(p);
        });
        
        const categoriaColors = {
            'CAFFETTERIA': 'from-amber-500 to-orange-600',
            'BEVANDE': 'from-purple-500 to-pink-600',
            'GELATI': 'from-cyan-500 to-blue-600',
            'PERSONALIZZATE': 'from-green-500 to-emerald-600'
        };
        
        const categoriaIcons = {
            'CAFFETTERIA': '‚òï',
            'BEVANDE': 'üç∑',
            'GELATI': 'üç¶',
            'PERSONALIZZATE': 'üí∞'
        };
        
        let html = '<div class="space-y-8">';
        
        for (const [categoria, items] of Object.entries(grouped)) {
            html += `
                <div class="space-y-4">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="bg-gradient-to-r ${categoriaColors[categoria] || 'from-gray-500 to-gray-600'} p-3 rounded-xl text-4xl">
                            ${categoriaIcons[categoria] || 'üì¶'}
                        </div>
                        <h2 class="text-2xl font-bold text-white">${categoria}</h2>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
            `;
            
            items.forEach(prodotto => {
                html += `
                    <button onclick="handleProductClick('${prodotto.id}')" 
                            class="bg-gradient-to-r ${categoriaColors[prodotto.categoria] || 'from-gray-500 to-gray-600'} text-white p-6 rounded-2xl shadow-xl hover:shadow-2xl transform hover:scale-105 transition-all duration-200 active:scale-95">
                        <div class="text-4xl mb-3">${prodotto.icona}</div>
                        <div class="font-bold text-lg mb-2 leading-tight">${prodotto.nome}</div>
                        <div class="text-2xl font-black">
                            ${prodotto.prezzo === 0 ? 'üí∞ Inserisci' : `‚Ç¨${prodotto.prezzo.toFixed(2)}`}
                        </div>
                    </button>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
        }
        
        html += '</div>';
        return html;
    }
    
    function renderSpese() {
        const ultimeSpoese = spese.slice(0, 10);
        const categorie = CONFIG.categorie_spese || [];
        
        let html = `
            <div class="space-y-6">
                <div class="bg-white/10 backdrop-blur-lg p-6 rounded-3xl border border-white/20">
                    <h2 class="text-2xl font-bold text-white mb-6 text-center">üí∏ Registra Spese</h2>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
        `;
        
        categorie.forEach(cat => {
            html += `
                <button onclick="handleSpesaClick('${cat.nome}', '${cat.icona}')"
                        class="bg-gradient-to-r ${cat.colore} text-white p-8 rounded-2xl shadow-xl hover:shadow-2xl transform hover:scale-105 transition-all active:scale-95">
                    <div class="text-5xl mb-3">${cat.icona}</div>
                    <div class="font-bold text-lg">${cat.nome}</div>
                </button>
            `;
        });
        
        html += `
                    </div>
                </div>
                
                <div class="bg-white/10 backdrop-blur-lg p-6 rounded-3xl border border-white/20">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold text-white">üìã Ultime Spese</h3>
                        <button onclick="refreshData()" class="bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-xl transition-all">
                            üîÑ Aggiorna
                        </button>
                    </div>
        `;
        
        if (ultimeSpoese.length === 0) {
            html += '<div class="text-white text-center py-8 opacity-75">Nessuna spesa registrata</div>';
        } else {
            html += '<div class="space-y-2 max-h-96 overflow-y-auto hide-scrollbar">';
            ultimeSpoese.forEach(s => {
                const dt = new Date(s.timestamp);
                html += `
                    <div class="bg-white/10 p-4 rounded-xl flex justify-between items-center hover:bg-white/20 transition-all">
                        <div class="text-white">
                            <div class="font-bold text-lg">${s.categoria_spesa}</div>
                            <div class="text-sm opacity-75">
                                ${dt.toLocaleDateString('it-IT')} - ${dt.toLocaleTimeString('it-IT')}
                            </div>
                        </div>
                        <div class="flex items-center gap-4">
                            <div class="text-2xl font-black text-red-400">-‚Ç¨${s.importo.toFixed(2)}</div>
                            <button onclick="deleteSpesa('${s.id}')" class="text-red-400 hover:text-red-300 p-2 hover:bg-red-500/20 rounded-lg transition-all">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
        }
        
        html += `
                </div>
            </div>
        `;
        
        return html;
    }
    
    function renderStatistiche() {
        const stats = calcolaStatistiche(state.periodo);
        
        let html = `
            <div class="space-y-6">
                <div class="flex gap-2 justify-center flex-wrap">
                    ${['oggi', 'settimana', 'mese'].map(p => `
                        <button onclick="changePeriodo('${p}')"
                                class="px-6 py-3 rounded-xl font-semibold transition-all ${
                                    state.periodo === p 
                                    ? 'bg-white text-purple-900 shadow-lg' 
                                    : 'bg-white/20 text-white hover:bg-white/30'
                                }">
                            ${p === 'oggi' ? 'üìÖ Oggi' : p === 'settimana' ? 'üìÜ Settimana' : 'üóìÔ∏è Mese'}
                        </button>
                    `).join('')}
                </div>
                
                <div class="grid md:grid-cols-3 gap-6">
                    <div class="bg-gradient-to-br from-green-500 to-emerald-600 p-8 rounded-3xl shadow-2xl text-white">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-semibold">Incasso Totale</h3>
                            <span class="text-3xl">üìà</span>
                        </div>
                        <div class="text-5xl font-black">‚Ç¨${stats.totaleIncasso.toFixed(2)}</div>
                        <div class="text-green-100 mt-2">${stats.periodoLabel}</div>
                    </div>
                    
                    <div class="bg-gradient-to-br from-red-500 to-red-600 p-8 rounded-3xl shadow-2xl text-white">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-semibold">Spese Totali</h3>
                            <span class="text-3xl">üìâ</span>
                        </div>
                        <div class="text-5xl font-black">‚Ç¨${stats.totaleSpese.toFixed(2)}</div>
                        <div class="text-red-100 mt-2">${stats.periodoLabel}</div>
                    </div>
                    
                    <div class="bg-gradient-to-br ${stats.profittoNetto >= 0 ? 'from-blue-500 to-indigo-600' : 'from-orange-500 to-red-600'} p-8 rounded-3xl shadow-2xl text-white">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-semibold">Profitto Netto</h3>
                            <span class="text-3xl">üí∞</span>
                        </div>
                        <div class="text-5xl font-black">‚Ç¨${stats.profittoNetto.toFixed(2)}</div>
                        <div class="text-blue-100 mt-2">${stats.totaleVendite} vendite</div>
                    </div>
                </div>
                
                <div class="bg-white/10 backdrop-blur-lg p-6 rounded-3xl border border-white/20">
                    <h3 class="text-2xl font-bold text-white mb-6">üìä Per Categoria</h3>
                    <div class="grid md:grid-cols-3 gap-4">
                        ${Object.entries(stats.perCategoria).map(([cat, data]) => `
                            <div class="bg-gradient-to-br from-purple-500 to-pink-600 p-6 rounded-2xl text-white">
                                <div class="text-lg font-semibold mb-2">${cat}</div>
                                <div class="text-3xl font-black mb-1">‚Ç¨${data.incasso.toFixed(2)}</div>
                                <div class="text-sm opacity-90">${data.vendite} vendite</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div class="bg-white/10 backdrop-blur-lg p-6 rounded-3xl border border-white/20">
                    <h3 class="text-2xl font-bold text-white mb-6">üèÜ Top 5 Prodotti</h3>
                    <div class="space-y-3">
                        ${stats.prodottiPiuVenduti.map((prod, idx) => `
                            <div class="bg-white/10 p-4 rounded-xl flex justify-between items-center">
                                <div class="flex items-center gap-4">
                                    <div class="text-3xl font-black text-yellow-400">#${idx + 1}</div>
                                    <div class="text-white">
                                        <div class="font-bold text-lg">${prod.nome}</div>
                                        <div class="text-sm opacity-75">${prod.quantita} vendite</div>
                                    </div>
                                </div>
                                <div class="text-2xl font-black text-white">‚Ç¨${prod.incasso.toFixed(2)}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <button onclick="openResetModal()" 
                        class="w-full bg-gradient-to-r from-gray-700 to-gray-900 text-white py-4 rounded-2xl font-bold text-lg shadow-xl hover:shadow-2xl transform hover:scale-105 transition-all flex items-center justify-center gap-3 border-2 border-red-500">
                    üóëÔ∏è üîí Reset Periodo (Password Richiesta)
                </button>
            </div>
        `;
        
        return html;
    }
    
    function renderStorico() {
        // Unisci vendite e spese
        const tutteTransazioni = [
            ...vendite.map(v => ({...v, tipo: 'vendita'})),
            ...spese.map(s => ({...s, tipo: 'spesa', nome_prodotto: s.categoria_spesa, prezzo: -s.importo}))
        ].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).slice(0, 100);
        
        let html = `
            <div class="space-y-4">
                <!-- Status connessione e report -->
                <div class="bg-white/10 backdrop-blur-lg p-4 rounded-2xl border border-white/20">
                    <div class="flex items-center justify-between">
                        <div class="text-white">
                            <div class="text-sm opacity-75">Stato connessione:</div>
                            <div class="font-bold ${state.online ? 'text-green-400' : 'text-red-400'}">
                                ${state.online ? 'üü¢ Online - Report automatico attivo' : 'üî¥ Offline'}
                            </div>
                            ${state.ultimoReport ? `<div class="text-xs opacity-50">Ultimo report: ${new Date(state.ultimoReport).toLocaleString('it-IT')}</div>` : ''}
                        </div>
                        ${state.online ? `
                            <button onclick="inviaReportManuale()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-xl transition-all text-sm">
                                üìß Invia Report Ora
                            </button>
                        ` : ''}
                    </div>
                </div>
                
                <button onclick="downloadExcel()" 
                        class="w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white py-4 rounded-2xl font-bold text-lg shadow-xl hover:shadow-2xl transform hover:scale-105 transition-all flex items-center justify-center gap-3">
                    üìä Scarica Excel Completo
                </button>
                
                <button onclick="openImportModal()" 
                        class="w-full bg-white/10 hover:bg-white/20 text-white/70 hover:text-white py-2 rounded-xl text-sm transition-all flex items-center justify-center gap-2 border border-white/20">
                    üì• Importa Dati da App Precedente
                </button>
                
                <div class="bg-white/10 backdrop-blur-lg p-6 rounded-3xl border border-white/20">
                    <h3 class="text-2xl font-bold text-white mb-6">üìã Ultime 100 Transazioni</h3>
        `;
        
        if (tutteTransazioni.length === 0) {
            html += '<div class="text-white text-center py-8 opacity-75">Nessuna transazione registrata</div>';
        } else {
            html += '<div class="space-y-2 max-h-[600px] overflow-y-auto hide-scrollbar">';
            tutteTransazioni.forEach(t => {
                const dt = new Date(t.timestamp);
                const isSpesa = t.tipo === 'spesa';
                const bgColor = isSpesa ? 'bg-red-900/30' : 'bg-white/10';
                const textColor = isSpesa ? 'text-red-300' : 'text-white';
                const priceColor = isSpesa ? 'text-red-400' : 'text-green-400';
                const icon = isSpesa ? 'üí∏' : 'üí∞';
                
                html += `
                    <div class="${bgColor} p-4 rounded-xl flex justify-between items-center hover:bg-white/20 transition-all border ${isSpesa ? 'border-red-500/30' : 'border-white/10'}">
                        <div class="${textColor}">
                            <div class="flex items-center gap-2">
                                <span class="text-2xl">${icon}</span>
                                <div>
                                    <div class="font-bold text-lg">${t.nome_prodotto}</div>
                                    <div class="text-sm opacity-75">
                                        ${dt.toLocaleDateString('it-IT')} - ${dt.toLocaleTimeString('it-IT')}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-4">
                            <div class="text-2xl font-black ${priceColor}">
                                ${isSpesa ? '-' : '+'}‚Ç¨${Math.abs(t.prezzo).toFixed(2)}
                            </div>
                            <button onclick="${isSpesa ? `deleteSpesa('${t.id}')` : `deleteVendita('${t.id}')`}" 
                                    class="text-red-400 hover:text-red-300 p-2 hover:bg-red-500/20 rounded-lg transition-all">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
        }
        
        html += `
                </div>
            </div>
        `;
        
        return html;
    }
    
    function renderNavigation() {
        return `
            <div class="fixed bottom-0 left-0 right-0 bg-white/10 backdrop-blur-lg border-t border-white/20 z-40 safe-area-inset-bottom">
                <div class="max-w-7xl mx-auto px-2 py-3">
                    <div class="grid grid-cols-4 gap-2">
                        ${['vendita', 'spese', 'statistiche', 'storico'].map(view => `
                            <button onclick="changeView('${view}')"
                                    class="flex flex-col items-center justify-center py-3 px-2 rounded-xl font-semibold transition-all ${
                                        state.view === view 
                                        ? 'bg-white text-purple-900 shadow-lg' 
                                        : 'bg-white/20 text-white hover:bg-white/30'
                                    }">
                                <span class="text-2xl mb-1">${
                                    view === 'vendita' ? 'üõí' : 
                                    view === 'spese' ? 'üí∏' : 
                                    view === 'statistiche' ? 'üìä' : 'üìã'
                                }</span>
                                <span class="text-xs capitalize">${view}</span>
                            </button>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;
    }
    
    function renderKeypad() {
        return `
            <div class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-3xl shadow-2xl max-w-md w-full p-6 border-2 border-white/20">
                    <div class="text-center mb-6">
                        <div class="text-5xl mb-3">${state.selectedProduct?.icona || 'üí∞'}</div>
                        <h3 class="text-2xl font-bold text-white mb-2">${state.selectedProduct?.nome || ''}</h3>
                        <p class="text-gray-400">Inserisci l'importo</p>
                    </div>
                    
                    <div class="bg-white/10 rounded-2xl p-6 mb-6 border-2 border-white/30">
                        <div class="text-center">
                            <div class="text-5xl font-black text-white">‚Ç¨${state.customPrice || '0'}</div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-3 mb-6">
                        ${['1','2','3','4','5','6','7','8','9',',','0','‚Üê'].map(key => `
                            <button onclick="handleKeypadPress('${key}')"
                                    class="bg-gradient-to-br from-slate-700 to-slate-800 hover:from-slate-600 hover:to-slate-700 text-white text-3xl font-bold p-6 rounded-2xl shadow-lg active:scale-95 transform transition-all border border-white/20">
                                ${key}
                            </button>
                        `).join('')}
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="closeKeypad()" 
                                class="bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white font-bold py-4 px-6 rounded-2xl shadow-lg active:scale-95 transform transition-all text-lg">
                            ‚ùå Annulla
                        </button>
                        <button onclick="confirmKeypad()" 
                                class="bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-bold py-4 px-6 rounded-2xl shadow-lg active:scale-95 transform transition-all text-lg">
                            ‚úÖ Conferma
                        </button>
                    </div>
                    
                    <button onclick="clearKeypad()" 
                            class="w-full mt-3 bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white font-bold py-3 px-6 rounded-2xl shadow-lg active:scale-95 transform transition-all">
                        üóëÔ∏è Cancella Tutto
                    </button>
                </div>
            </div>
        `;
    }
    
    function renderResetModal() {
        return `
            <div class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                <div class="bg-gradient-to-br from-red-900 to-red-950 rounded-3xl shadow-2xl max-w-md w-full p-8 border-2 border-red-500">
                    <div class="text-center mb-6">
                        <div class="text-6xl mb-4">‚ö†Ô∏è</div>
                        <h3 class="text-3xl font-bold text-white mb-2">Reset Periodo</h3>
                        <p class="text-red-200">Elimina tutti i dati del periodo: <span class="font-bold">${state.periodo}</span></p>
                    </div>
                    
                    <div class="bg-white/10 rounded-2xl p-6 mb-6 border-2 border-red-400">
                        <label class="block text-white font-semibold mb-3 text-center">Inserisci Password</label>
                        <input type="password" 
                               id="resetPasswordInput"
                               value="${state.resetPassword}"
                               oninput="updateResetPassword(this.value)"
                               placeholder="Password" 
                               maxlength="10"
                               class="w-full px-6 py-4 bg-white/20 text-white text-center text-2xl font-bold rounded-xl border-2 border-white/30 focus:border-white focus:outline-none placeholder-white/50">
                        <p class="text-xs text-red-200 mt-3 text-center">‚ö†Ô∏è Questa azione √® irreversibile!</p>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="closeResetModal()" 
                                class="bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800 text-white font-bold py-4 px-6 rounded-2xl shadow-lg active:scale-95 transform transition-all">
                            Annulla
                        </button>
                        <button onclick="confirmReset()" 
                                class="bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white font-bold py-4 px-6 rounded-2xl shadow-lg active:scale-95 transform transition-all">
                            üóëÔ∏è Reset
                        </button>
                    </div>
                </div>
            </div>
        `;
    }
    
    function renderImportModal() {
        return `
            <div class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-3xl shadow-2xl max-w-lg w-full p-8 border-2 border-white/20">
                    <div class="text-center mb-6">
                        <div class="text-6xl mb-4">üì•</div>
                        <h3 class="text-2xl font-bold text-white mb-2">Importa Dati</h3>
                        <p class="text-gray-400">Importa vendite e spese dalla vecchia app</p>
                    </div>
                    
                    <div class="bg-white/10 rounded-2xl p-4 mb-6 border border-white/20">
                        <p class="text-white text-sm mb-4">
                            <strong>Istruzioni:</strong><br>
                            1. Apri la vecchia app sul telefono<br>
                            2. Apri la console del browser (F12 ‚Üí Console)<br>
                            3. Copia questo comando e incollalo:<br>
                        </p>
                        <code class="block bg-black/50 p-3 rounded-lg text-green-400 text-xs overflow-x-auto">
copy(JSON.stringify({vendite: JSON.parse(localStorage.getItem('vendite')), spese: JSON.parse(localStorage.getItem('spese'))}))
                        </code>
                        <p class="text-white text-sm mt-4">
                            4. Incolla qui sotto il JSON copiato:
                        </p>
                    </div>
                    
                    <textarea id="importDataInput" 
                              placeholder='{"vendite": [...], "spese": [...]}'
                              class="w-full h-32 px-4 py-3 bg-white/10 text-white rounded-xl border border-white/30 focus:border-white focus:outline-none placeholder-white/30 text-sm font-mono"></textarea>
                    
                    <div class="grid grid-cols-2 gap-3 mt-4">
                        <button onclick="closeImportModal()" 
                                class="bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800 text-white font-bold py-4 px-6 rounded-2xl shadow-lg active:scale-95 transform transition-all">
                            Annulla
                        </button>
                        <button onclick="confirmImport()" 
                                class="bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-bold py-4 px-6 rounded-2xl shadow-lg active:scale-95 transform transition-all">
                            üì• Importa
                        </button>
                    </div>
                </div>
            </div>
        `;
    }
    
    // ==================== CALCOLO STATISTICHE ====================
    
    function calcolaStatistiche(periodo) {
        const now = new Date();
        let dataInizio;
        
        if (periodo === 'oggi') {
            dataInizio = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        } else if (periodo === 'settimana') {
            dataInizio = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
        } else {
            dataInizio = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
        }
        
        const venditePeriodo = vendite.filter(v => new Date(v.timestamp) >= dataInizio);
        const spesePeriodo = spese.filter(s => new Date(s.timestamp) >= dataInizio);
        
        const totaleVendite = venditePeriodo.length;
        const totaleIncasso = venditePeriodo.reduce((sum, v) => sum + v.prezzo, 0);
        const totaleSpese = spesePeriodo.reduce((sum, s) => sum + s.importo, 0);
        const profittoNetto = totaleIncasso - totaleSpese;
        
        const perCategoria = {};
        venditePeriodo.forEach(v => {
            if (!perCategoria[v.categoria]) {
                perCategoria[v.categoria] = {vendite: 0, incasso: 0};
            }
            perCategoria[v.categoria].vendite++;
            perCategoria[v.categoria].incasso += v.prezzo;
        });
        
        const prodottiCount = {};
        venditePeriodo.forEach(v => {
            if (!prodottiCount[v.nome_prodotto]) {
                prodottiCount[v.nome_prodotto] = {nome: v.nome_prodotto, quantita: 0, incasso: 0};
            }
            prodottiCount[v.nome_prodotto].quantita++;
            prodottiCount[v.nome_prodotto].incasso += v.prezzo;
        });
        
        const prodottiPiuVenduti = Object.values(prodottiCount)
            .sort((a, b) => b.quantita - a.quantita)
            .slice(0, 5);
        
        return {
            totaleVendite,
            totaleIncasso,
            totaleSpese,
            profittoNetto,
            perCategoria,
            prodottiPiuVenduti,
            periodoLabel: periodo === 'oggi' ? 'Oggi' : periodo === 'settimana' ? 'Ultimi 7 giorni' : 'Ultimi 30 giorni'
        };
    }
    
    // ==================== EVENT HANDLERS ====================
    
    function changeView(view) {
        state.view = view;
        render();
        window.scrollTo(0, 0);
    }
    
    function changePeriodo(periodo) {
        state.periodo = periodo;
        render();
    }
    
    function handleProductClick(prodottoId) {
        const prodotto = prodotti.find(p => p.id === prodottoId);
        if (!prodotto) return;
        
        if (prodotto.prezzo === 0 || prodotto.categoria === 'PERSONALIZZATE') {
            state.selectedProduct = prodotto;
            state.customPrice = '';
            state.keypadMode = 'vendita';
            state.showKeypad = true;
            render();
        } else {
            registraVendita(prodotto, prodotto.prezzo);
        }
    }
    
    function handleSpesaClick(categoria, icona) {
        state.selectedSpesaCategoria = categoria;
        state.selectedProduct = {nome: categoria, icona: icona};
        state.customPrice = '';
        state.keypadMode = 'spesa';
        state.showKeypad = true;
        render();
    }
    
    function handleKeypadPress(key) {
        if (key === '‚Üê') {
            state.customPrice = state.customPrice.slice(0, -1);
        } else if (key === ',') {
            if (!state.customPrice.includes(',')) {
                state.customPrice += ',';
            }
        } else {
            if (state.customPrice.includes(',')) {
                const parts = state.customPrice.split(',');
                if (parts[1] && parts[1].length >= 2) return;
            }
            state.customPrice += key;
        }
        render();
    }
    
    function closeKeypad() {
        state.showKeypad = false;
        state.customPrice = '';
        state.selectedProduct = null;
        render();
    }
    
    function clearKeypad() {
        state.customPrice = '';
        render();
    }
    
    async function confirmKeypad() {
        const prezzo = parseFloat(state.customPrice.replace(',', '.'));
        if (isNaN(prezzo) || prezzo <= 0) {
            showFeedback('‚ùå Inserisci un importo valido!');
            return;
        }
        
        state.showKeypad = false;
        
        if (state.keypadMode === 'vendita') {
            await registraVendita(state.selectedProduct, prezzo);
        } else if (state.keypadMode === 'spesa') {
            await registraSpesa(state.selectedSpesaCategoria, prezzo);
        }
        
        state.customPrice = '';
        state.selectedProduct = null;
        render();
    }
    
    async function registraVendita(prodotto, prezzo) {
        try {
            await apiCall('/api/vendite', 'POST', {
                prodotto_id: prodotto.id,
                nome_prodotto: prodotto.nome,
                prezzo: prezzo,
                categoria: prodotto.categoria
            });
            
            showFeedback(`‚úÖ ${prodotto.nome} - ‚Ç¨${prezzo.toFixed(2)}`);
            await refreshData();
        } catch (error) {
            showFeedback('‚ùå Errore registrazione vendita');
        }
    }
    
    async function registraSpesa(categoria, importo) {
        try {
            await apiCall('/api/spese', 'POST', {
                categoria_spesa: categoria,
                importo: importo,
                note: ''
            });
            
            showFeedback(`‚úÖ Spesa: ${categoria} - ‚Ç¨${importo.toFixed(2)}`);
            await refreshData();
        } catch (error) {
            showFeedback('‚ùå Errore registrazione spesa');
        }
    }
    
    async function deleteVendita(id) {
        if (!confirm('Eliminare questa vendita?')) return;
        
        try {
            await apiCall(`/api/vendite/${id}`, 'DELETE');
            showFeedback('‚úÖ Vendita eliminata');
            await refreshData();
            render();
        } catch (error) {
            showFeedback('‚ùå Errore eliminazione');
        }
    }
    
    async function deleteSpesa(id) {
        if (!confirm('Eliminare questa spesa?')) return;
        
        try {
            await apiCall(`/api/spese/${id}`, 'DELETE');
            showFeedback('‚úÖ Spesa eliminata');
            await refreshData();
            render();
        } catch (error) {
            showFeedback('‚ùå Errore eliminazione');
        }
    }
    
    function openResetModal() {
        state.showResetModal = true;
        state.resetPassword = '';
        render();
    }
    
    function closeResetModal() {
        state.showResetModal = false;
        state.resetPassword = '';
        render();
    }
    
    function updateResetPassword(value) {
        state.resetPassword = value;
    }
    
    async function confirmReset() {
        try {
            await apiCall('/api/reset', 'POST', {
                password: state.resetPassword,
                periodo: state.periodo
            });
            
            state.showResetModal = false;
            state.resetPassword = '';
            showFeedback('‚úÖ Reset completato!');
            await refreshData();
            render();
        } catch (error) {
            showFeedback('‚ùå Password errata!');
        }
    }
    
    function openImportModal() {
        state.showImportModal = true;
        render();
    }
    
    function closeImportModal() {
        state.showImportModal = false;
        render();
    }
    
    async function confirmImport() {
        const input = document.getElementById('importDataInput');
        const jsonText = input?.value?.trim();
        
        if (!jsonText) {
            showFeedback('‚ùå Inserisci i dati da importare');
            return;
        }
        
        try {
            const data = JSON.parse(jsonText);
            const result = await apiCall('/api/import-dati', 'POST', data);
            
            state.showImportModal = false;
            showFeedback(`‚úÖ Importati: ${result.vendite_importate} vendite, ${result.spese_importate} spese`);
            await refreshData();
            render();
        } catch (error) {
            showFeedback('‚ùå Errore formato JSON');
        }
    }
    
    async function downloadExcel() {
        try {
            window.open(`${API_BASE}/api/download-excel`, '_blank');
            showFeedback('üìä Download Excel avviato');
        } catch (error) {
            showFeedback('‚ùå Errore download');
        }
    }
    
    async function inviaReportManuale() {
        showFeedback('üìß Invio report in corso...');
        
        try {
            await apiCall('/api/invia-report', 'POST');
            showFeedback('‚úÖ Report inviato via email!');
            await checkStatus();
        } catch (error) {
            showFeedback('‚ùå Errore invio email');
        }
    }
    
    function showFeedback(message) {
        state.feedback = message;
        render();
        setTimeout(() => {
            state.feedback = '';
            render();
        }, 2500);
    }
    
    // ==================== INIT ====================
    
    init();
    </script>
</body>
</html>
